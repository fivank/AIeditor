<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceNotes AI Manager</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Estilos base y utilidades */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animaci√≥n de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animaci√≥n de grabaci√≥n */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-red {
            to { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }

        /* Scrollbar bonita */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS SVG ---
        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Wand: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="M3 21l9-9"/><path d="M12.2 6.2 11 5"/></svg>,
            Merge: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3"/><path d="M12 12.3v9.3"/><path d="m8 18 4 4 4-4"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        };

        // --- CONFIGURACI√ìN INICIAL ---
        const DEFAULT_API_KEY = "";
        const DEFAULT_MODEL = "gemini-2.0-flash-exp";
        const DEFAULT_PROMPTS = {
            merge: "Combina las siguientes notas en un √∫nico texto coherente, bien estructurado y resumido. Usa Markdown para dar formato si es necesario.",
            style: "Reescribe el siguiente contenido aplicando estrictamente el siguiente estilo o tono: {STYLE}. Mant√©n la informaci√≥n original pero cambia la forma de expresarla.",
            generate: "Crea una nota nueva usando el siguiente contexto. Respeta el idioma y el nivel de detalle del material."
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const moveItem = (array, from, to) => {
            const arr = [...array];
            const [item] = arr.splice(from, 1);
            arr.splice(to, 0, item);
            return arr;
        };

        // --- API GEMINI ---
        async function callGemini(apiKey, model, prompt, content) {
            if (!apiKey || apiKey.length < 10) throw new Error("Falta la API Key.");

            // Usar el modelo configurado
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const fullText = `${prompt}\n\n--- CONTENIDO ---\n${content}`;
            const payload = { contents: [{ parts: [{ text: fullText }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.error?.code === 404) {
                        throw new Error(`Modelo '${model}' no encontrado. Revisa el nombre en Configuraci√≥n.`);
                    }
                    throw new Error(data.error?.message || 'Error desconocido en la API');
                }

                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se gener√≥ respuesta.";
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [books, setBooks] = useState([]);
            const [settings, setSettings] = useState({
                apiKey: DEFAULT_API_KEY,
                model: DEFAULT_MODEL,
                prompts: { ...DEFAULT_PROMPTS }
            });
            const [view, setView] = useState('home');
            const [activeBookId, setActiveBookId] = useState(null);
            const [activeChapterId, setActiveChapterId] = useState(null);
            const [loading, setLoading] = useState(false);
            const [testStatus, setTestStatus] = useState(null); // null, 'loading', 'success', 'error'
            const [testMsg, setTestMsg] = useState("");
            const [editingBook, setEditingBook] = useState({ id: null, title: "" });
            const [editingChapter, setEditingChapter] = useState({ id: null, title: "" });
            const [newBookTitle, setNewBookTitle] = useState("");
            const [newChapterTitle, setNewChapterTitle] = useState("");

            useEffect(() => {
                const savedBooks = localStorage.getItem('voiceNotes_books');
                const savedSettings = localStorage.getItem('voiceNotes_settings');
                if (savedBooks) setBooks(JSON.parse(savedBooks));
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    setSettings({
                        apiKey: parsed.apiKey || DEFAULT_API_KEY,
                        model: parsed.model || DEFAULT_MODEL,
                        prompts: { ...DEFAULT_PROMPTS, ...(parsed.prompts || {}) }
                    });
                }
            }, []);

            useEffect(() => { localStorage.setItem('voiceNotes_books', JSON.stringify(books)); }, [books]);
            useEffect(() => { localStorage.setItem('voiceNotes_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { setNewChapterTitle(""); setEditingChapter({ id: null, title: "" }); }, [activeBookId]);

            // Helpers de navegaci√≥n y datos
            const addBook = (title) => setBooks([...books, { id: generateId(), title, chapters: [] }]);
            const renameBook = (id, title) => setBooks(books.map(b => b.id === id ? { ...b, title } : b));
            const deleteBook = (id) => setBooks(books.filter(b => b.id !== id));
            const reorderBook = (id, direction) => {
                const index = books.findIndex(b => b.id === id);
                const target = index + direction;
                if (target < 0 || target >= books.length) return;
                setBooks(moveItem(books, index, target));
            };
            const addChapter = (bookId, title) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: [...b.chapters, { id: generateId(), title, notes: [] }] } : b));
            };
            const renameChapter = (bookId, chapterId, title) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, title } : c) } : b));
            };
            const handleAddBook = () => {
                const cleanTitle = newBookTitle.trim();
                if (!cleanTitle) return;
                addBook(cleanTitle);
                setNewBookTitle("");
            };
            const handleAddChapter = () => {
                const cleanTitle = newChapterTitle.trim();
                if (!cleanTitle || !activeBookId) return;
                addChapter(activeBookId, cleanTitle);
                setNewChapterTitle("");
            };
            const addNote = (bookId, chapterId, content) => {
                if (!content || !content.trim()) return;
                const cleanContent = content.charAt(0).toUpperCase() + content.slice(1).trim();
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: [...c.notes, { id: generateId(), content: cleanContent, timestamp: Date.now() }] } : c) } : b));
            };
            const editNote = (bookId, chapterId, noteId, content) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: c.notes.map(n => n.id === noteId ? { ...n, content } : n) } : c) } : b));
            };
            const updateNotes = (bookId, chapterId, newNotes) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: newNotes } : c) } : b));
            };
            const updateBookChapters = (bookId, newChapters) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: newChapters } : b));
            };
            const deleteChapter = (bookId, chapterId) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.filter(c => c.id !== chapterId) } : b));
            };
            const reorderChapter = (bookId, chapterId, direction) => {
                const book = books.find(b => b.id === bookId);
                const index = book?.chapters.findIndex(c => c.id === chapterId);
                if (index === undefined || index < 0) return;
                const target = index + direction;
                if (target < 0 || !book || target >= book.chapters.length) return;
                const newChapters = moveItem(book.chapters, index, target);
                updateBookChapters(bookId, newChapters);
            };
            const moveChapterToBook = (sourceBookId, chapterId, targetBookId) => {
                if (sourceBookId === targetBookId) return;
                const source = books.find(b => b.id === sourceBookId);
                const chapter = source?.chapters.find(c => c.id === chapterId);
                if (!chapter) return;
                const cleanedSource = source.chapters.filter(c => c.id !== chapterId);
                setBooks(books.map(b => {
                    if (b.id === sourceBookId) return { ...b, chapters: cleanedSource };
                    if (b.id === targetBookId) return { ...b, chapters: [...b.chapters, chapter] };
                    return b;
                }));
            };
            const transferNote = (fromBookId, fromChapterId, noteId, targetBookId, targetChapterId, mode = 'move') => {
                const sourceBook = books.find(b => b.id === fromBookId);
                const targetBook = books.find(b => b.id === targetBookId);
                const sourceChapter = sourceBook?.chapters.find(c => c.id === fromChapterId);
                const targetChapter = targetBook?.chapters.find(c => c.id === targetChapterId);
                const note = sourceChapter?.notes.find(n => n.id === noteId);
                if (!note || !sourceBook || !targetBook || !targetChapter) return;

                // Si el origen y destino son el mismo libro, necesitamos manejar la eliminaci√≥n y la inserci√≥n
                // dentro del mismo objeto para que no se pierda la nota al devolver en el primer condicional.
                if (fromBookId === targetBookId) {
                    const newNote = mode === 'copy' ? { ...note, id: generateId(), timestamp: Date.now() } : note;
                    setBooks(books.map(b => {
                        if (b.id !== fromBookId) return b;

                        const chapters = b.chapters.map(c => {
                            if (c.id === fromChapterId && mode === 'move' && fromChapterId !== targetChapterId) {
                                return { ...c, notes: c.notes.filter(n => n.id !== noteId) };
                            }
                            if (c.id === targetChapterId) {
                                if (fromChapterId === targetChapterId && mode === 'move') return c; // Nada que mover
                                return { ...c, notes: [...c.notes, newNote] };
                            }
                            return c;
                        });

                        return { ...b, chapters };
                    }));
                    return;
                }

                const updatedBooks = books.map(b => {
                    if (b.id === fromBookId) {
                        return { ...b, chapters: b.chapters.map(c => c.id === fromChapterId ? { ...c, notes: c.notes.filter(n => !(mode === 'move' && n.id === noteId)) } : c) };
                    }
                    if (b.id === targetBookId) {
                        return { ...b, chapters: b.chapters.map(c => c.id === targetChapterId ? { ...c, notes: [...c.notes, mode === 'copy' ? { ...note, id: generateId(), timestamp: Date.now() } : note] } : c) };
                    }
                    return b;
                });
                setBooks(updatedBooks);
            };

            const goHome = () => { setView('home'); setActiveBookId(null); setActiveChapterId(null); };
            const goBook = (id) => { setActiveBookId(id); setView('book'); };
            const goChapter = (id) => { setActiveChapterId(id); setView('chapter'); };
            const goSettings = () => setView('settings');

            const startBookEdit = (book) => setEditingBook({ id: book.id, title: book.title });
            const saveBookEdit = () => {
                if (!editingBook.title.trim()) return;
                renameBook(editingBook.id, editingBook.title.trim());
                setEditingBook({ id: null, title: "" });
            };
            const cancelBookEdit = () => setEditingBook({ id: null, title: "" });

            const startChapterEdit = (chapter) => setEditingChapter({ id: chapter.id, title: chapter.title });
            const saveChapterEdit = () => {
                if (!editingChapter.title.trim()) return;
                renameChapter(activeBookId, editingChapter.id, editingChapter.title.trim());
                setEditingChapter({ id: null, title: "" });
            };
            const cancelChapterEdit = () => setEditingChapter({ id: null, title: "" });

            // Componente de Pantalla de Carga
            if (loading) {
                return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                        <div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
                            <div className="loader mb-4"></div>
                            <p className="text-gray-700 font-medium">Procesando con IA...</p>
                        </div>
                    </div>
                );
            }

            // Header
            const Header = ({ title, onBack }) => (
                <header className="glass-panel sticky top-0 z-10 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                    <div className="flex items-center gap-2">
                        {onBack && <button onClick={onBack} className="p-1 rounded-full hover:bg-gray-100 text-gray-600"><Icons.ChevronLeft /></button>}
                        <h1 className="text-lg font-bold text-gray-800 truncate max-w-[200px]">{title}</h1>
                    </div>
                    <button onClick={goSettings} className="p-2 text-gray-500 hover:text-blue-600"><Icons.Settings /></button>
                </header>
            );

            // --- VISTA: SETTINGS (Mejorada) ---
            if (view === 'settings') {
                const testConnection = async () => {
                    setTestStatus('loading');
                    try {
                        await callGemini(settings.apiKey, settings.model, "Di hola", "Test de conexi√≥n");
                        setTestStatus('success');
                        setTestMsg("¬°Conexi√≥n Exitosa!");
                    } catch (e) {
                        setTestStatus('error');
                        setTestMsg(e.message);
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-50">
                        <Header title="Configuraci√≥n" onBack={() => view === 'home' ? null : window.history.back() || goHome()} />
                        <div className="p-4 max-w-md mx-auto space-y-6">
                            
                            {/* Secci√≥n API */}
                            <div className="bg-white p-4 rounded-lg shadow space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                                    <input type="text" value={settings.apiKey} onChange={(e) => setSettings({...settings, apiKey: e.target.value})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="AIzaSy..." />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Modelo (Model Name)</label>
                                    <div className="flex gap-2">
                                        <select 
                                            value={settings.model} 
                                            onChange={(e) => setSettings({...settings, model: e.target.value})}
                                            className="w-full p-2 border rounded-md bg-gray-50 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Predeterminado)</option>
                                            <option value="gemini-1.5-flash">gemini-1.5-flash (Est√°ndar)</option>
                                            <option value="gemini-1.5-pro">gemini-1.5-pro (M√°s inteligente)</option>
                                            <option value="gemini-pro">gemini-pro (Legacy)</option>
                                        </select>
                                    </div>
                                    {/* Opci√≥n manual por si acaso */}
                                    <input 
                                        type="text" 
                                        value={settings.model}
                                        onChange={(e) => setSettings({...settings, model: e.target.value})}
                                        placeholder="Nombre manual del modelo..."
                                        className="w-full mt-2 p-2 border border-dashed rounded-md text-xs text-gray-500"
                                    />
                                </div>

                                <button onClick={testConnection} disabled={testStatus === 'loading'}
                                    className={`w-full py-2 px-4 rounded text-sm font-medium border transition flex items-center justify-center gap-2
                                    ${testStatus === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 
                                      testStatus === 'error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {testStatus === 'loading' ? <div className="loader w-4 h-4 border-2 border-gray-400 border-t-transparent"></div> : 
                                     testStatus === 'success' ? <Icons.Check /> : 
                                     testStatus === 'error' ? <Icons.Alert /> : "Probar Conexi√≥n"}
                                    {testStatus === 'loading' ? ' Probando...' : testStatus === 'success' ? ' Conectado' : testStatus === 'error' ? ' Error' : ' Probar Conexi√≥n'}
                                </button>
                                {testMsg && <p className={`text-xs ${testStatus === 'error' ? 'text-red-600' : 'text-green-600'}`}>{testMsg}</p>}
                            </div>

                            {/* Secci√≥n Prompts */}
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h3 className="font-medium text-gray-800 mb-3 border-b pb-2">Prompts</h3>
                                <div className="mb-4">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Fusi√≥n</label>
                                    <textarea value={settings.prompts.merge} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, merge: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Estilo</label>
                                    <textarea value={settings.prompts.style} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, style: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                                <div className="mt-4">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Generaci√≥n de notas</label>
                                    <textarea value={settings.prompts.generate} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, generate: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                            </div>

                            <button onClick={() => { if(activeChapterId) goChapter(activeChapterId); else if(activeBookId) goBook(activeBookId); else goHome(); }}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition shadow-lg">
                                Guardar y Salir
                            </button>
                        </div>
                    </div>
                );
            }

            const activeBook = books.find(b => b.id === activeBookId);
            const activeChapter = activeBook?.chapters.find(c => c.id === activeChapterId);

            if (view === 'home') {
                return (
                    <div className="min-h-screen flex flex-col">
                        <Header title="Mis Libros" />
                        <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-4">
                            <div className="bg-blue-50 border border-blue-100 text-blue-900 text-sm p-4 rounded-xl shadow-sm">
                                <p className="font-semibold mb-1">Organiza tus libros y cap√≠tulos</p>
                                <p className="leading-snug">Renombra, reordena y borra con botones visibles. Usa el formulario inferior para crear nuevos libros sin depender de ventanas emergentes.</p>
                            </div>

                            {books.length === 0 && <div className="text-center py-10 text-gray-400"><p>No tienes libros creados.</p></div>}

                            <div className="space-y-3">
                                {books.map((book, idx) => (
                                    <div key={book.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3">
                                        <div onClick={() => goBook(book.id)} className="p-3 bg-blue-50 text-blue-600 rounded-lg cursor-pointer" aria-label={`Abrir ${book.title}`}>
                                            <Icons.Book />
                                        </div>
                                        <div className="flex-1">
                                            {editingBook.id === book.id ? (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        value={editingBook.title}
                                                        onChange={(e) => setEditingBook({ ...editingBook, title: e.target.value})}
                                                        className="w-full p-2 border rounded-md text-sm"
                                                        autoFocus
                                                    />
                                                    <button onClick={saveBookEdit} className="px-3 py-1 rounded-md text-xs bg-green-100 text-green-700 font-semibold">Guardar</button>
                                                    <button onClick={cancelBookEdit} className="px-3 py-1 rounded-md text-xs bg-gray-100 text-gray-600">Cancelar</button>
                                                </div>
                                            ) : (
                                                <div onClick={() => goBook(book.id)} className="cursor-pointer">
                                                    <h3 className="font-semibold text-gray-800">{book.title}</h3>
                                                    <p className="text-xs text-gray-500">{book.chapters.length} cap√≠tulos</p>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex items-center gap-2 text-gray-600">
                                            <button onClick={() => reorderBook(book.id, -1)} className="px-2 py-1 rounded-full border border-gray-200 hover:border-blue-300 hover:text-blue-700 text-xs" aria-label="Mover arriba">Arriba</button>
                                            <button onClick={() => reorderBook(book.id, 1)} className="px-2 py-1 rounded-full border border-gray-200 hover:border-blue-300 hover:text-blue-700 text-xs" aria-label="Mover abajo">Abajo</button>
                                            {editingBook.id === book.id ? null : <button onClick={() => startBookEdit(book)} className="px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 text-xs font-semibold">Renombrar</button>}
                                            <button onClick={() => { if(confirm('¬øBorrar libro y todo su contenido?')) deleteBook(book.id); }} className="p-2 rounded-full hover:bg-red-50 text-red-600" aria-label={`Borrar ${book.title}`}><Icons.Trash /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>
                        <div className="p-4 bg-white border-t sticky bottom-0">
                            <div className="bg-gray-50 border rounded-xl p-3 space-y-2">
                                <label className="text-xs font-semibold text-gray-600 uppercase">Crear nuevo libro</label>
                                <div className="flex gap-2">
                                    <input
                                        value={newBookTitle}
                                        onChange={(e) => setNewBookTitle(e.target.value)}
                                        placeholder="Ej. Gu√≠as de proyecto"
                                        className="flex-1 p-2 rounded-lg border bg-white text-sm focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                        onClick={handleAddBook}
                                        disabled={!newBookTitle.trim()}
                                        className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 shadow ${newBookTitle.trim() ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`}
                                    >
                                        <Icons.Plus />
                                        A√±adir
                                    </button>
                                </div>
                                <p className="text-[11px] text-gray-500">El nombre se guarda al instante. Puedes reordenar con los botones de arriba/abajo visibles.</p>
                            </div>
                        </div>
                    </div>
                );
            }
            if (view === 'book' && activeBook) {
                const handleStyleBook = async () => {
                    if(activeBook.chapters.length === 0) return alert("Libro vac√≠o.");
                    const styleDesc = prompt("Describe el estilo para todo el libro:");
                    if (!styleDesc) return;
                    setLoading(true);
                    try {
                        let newChapters = JSON.parse(JSON.stringify(activeBook.chapters));
                        for (let chapter of newChapters) {
                            if (chapter.notes.length === 0) continue;
                            const chapterText = chapter.notes.map(n => n.content).join("\n");
                            const finalPrompt = settings.prompts.style.replace('{STYLE}', styleDesc);
                            const newText = await callGemini(settings.apiKey, settings.model, finalPrompt, chapterText);
                            chapter.notes = [{ id: generateId(), content: newText, timestamp: Date.now() }];
                        }
                        updateBookChapters(activeBook.id, newChapters);
                        alert("¬°Libro reescrito!");
                    } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
                };

                const handleGenerateBook = async () => {
                    if(activeBook.chapters.length === 0) return alert("Libro vac√≠o.");
                    const promptText = prompt("¬øQu√© necesitas generar a partir del libro?");
                    if (!promptText) return;
                    setLoading(true);
                    try {
                        const bookContent = activeBook.chapters.map(ch => `Cap√≠tulo: ${ch.title}\n${ch.notes.map(n => n.content).join('\n')}`).join('\n\n');
                        const finalPrompt = `${settings.prompts.generate}\n\nPetici√≥n: ${promptText}`;
                        const newText = await callGemini(settings.apiKey, settings.model, finalPrompt, bookContent);
                        const newChapterId = generateId();
                        const newNoteId = generateId();
                        setBooks(books.map(b => b.id === activeBook.id ? {
                            ...b,
                            chapters: [...b.chapters, { id: newChapterId, title: `Generado ${new Date().toLocaleTimeString()}`, notes: [{ id: newNoteId, content: newText, timestamp: Date.now() }] }]
                        } : b));
                        alert("Nueva nota generada y guardada en un cap√≠tulo nuevo.");
                    } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
                };

                return (
                    <div className="min-h-screen flex flex-col">
                        <Header title={activeBook.title} onBack={goHome} />
                        <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-4">
                            <div className="bg-emerald-50 border border-emerald-100 text-emerald-900 text-sm p-4 rounded-xl shadow-sm flex flex-col gap-2">
                                <p className="font-semibold">Ajusta tus cap√≠tulos con claridad</p>
                                <p className="leading-snug">Los controles de estilo y generaci√≥n est√°n siempre visibles. Usa los botones renombrar y reordenar para mantener el orden antes de aplicar IA.</p>
                            </div>
                            <div className="flex flex-wrap items-center justify-between gap-2">
                                <button onClick={handleGenerateBook} className="text-xs flex items-center gap-2 bg-amber-50 text-amber-700 px-4 py-2 rounded-full font-semibold border border-amber-200 shadow-sm">üí° Generar resumen</button>
                                <button onClick={handleStyleBook} className="text-xs flex items-center gap-2 bg-purple-50 text-purple-700 px-4 py-2 rounded-full font-semibold border border-purple-200 shadow-sm"><Icons.Wand className="w-3 h-3" /> Estilo del libro</button>
                            </div>
                            {activeBook.chapters.length === 0 && <div className="text-center py-10 text-gray-400"><p>Libro vac√≠o.</p></div>}
                            <div className="space-y-3">
                                {activeBook.chapters.map((chap, idx) => (
                                    <div key={chap.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3">
                                        <div onClick={() => goChapter(chap.id)} className="p-3 bg-indigo-50 text-indigo-600 rounded-lg cursor-pointer" aria-label={`Abrir ${chap.title}`}><Icons.Folder /></div>
                                        <div className="flex-1">
                                            {editingChapter.id === chap.id ? (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        value={editingChapter.title}
                                                        onChange={(e) => setEditingChapter({ ...editingChapter, title: e.target.value })}
                                                        className="w-full p-2 border rounded-md text-sm"
                                                        autoFocus
                                                    />
                                                    <button onClick={saveChapterEdit} className="px-3 py-1 rounded-md text-xs bg-green-100 text-green-700 font-semibold">Guardar</button>
                                                    <button onClick={cancelChapterEdit} className="px-3 py-1 rounded-md text-xs bg-gray-100 text-gray-600">Cancelar</button>
                                                </div>
                                            ) : (
                                                <div onClick={() => goChapter(chap.id)} className="cursor-pointer">
                                                    <h3 className="font-semibold text-gray-800">{chap.title}</h3><p className="text-xs text-gray-500">{chap.notes.length} notas</p>
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex items-center gap-2 text-gray-600 text-sm">
                                            <button onClick={() => reorderChapter(activeBook.id, chap.id, -1)} className="px-2 py-1 rounded-full border border-gray-200 hover:border-indigo-300 hover:text-indigo-700" aria-label="Mover arriba">Arriba</button>
                                            <button onClick={() => reorderChapter(activeBook.id, chap.id, 1)} className="px-2 py-1 rounded-full border border-gray-200 hover:border-indigo-300 hover:text-indigo-700" aria-label="Mover abajo">Abajo</button>
                                            {editingChapter.id === chap.id ? null : <button onClick={() => startChapterEdit(chap)} className="px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 font-semibold">Renombrar</button>}
                                            <button onClick={() => { const target = prompt('Mover a libro (escribe el nombre exacto).'); const targetBook = books.find(b => b.title === target); if(targetBook) moveChapterToBook(activeBook.id, chap.id, targetBook.id); }} className="px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100" title="Mover a otro libro">Mover</button>
                                            <button onClick={() => { if(confirm('¬øBorrar cap√≠tulo y sus notas?')) deleteChapter(activeBook.id, chap.id); }} className="p-2 rounded-full hover:bg-red-50 text-red-600" aria-label={`Borrar ${chap.title}`}><Icons.Trash /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </main>
                        <div className="p-4 bg-white border-t sticky bottom-0">
                            <div className="bg-indigo-50 border rounded-xl p-3 space-y-2">
                                <label className="text-xs font-semibold text-indigo-800 uppercase">A√±adir cap√≠tulo</label>
                                <div className="flex gap-2">
                                    <input
                                        value={newChapterTitle}
                                        onChange={(e) => setNewChapterTitle(e.target.value)}
                                        placeholder="Ej. Introducci√≥n clara"
                                        className="flex-1 p-2 rounded-lg border bg-white text-sm focus:ring-2 focus:ring-indigo-500"
                                    />
                                    <button
                                        onClick={handleAddChapter}
                                        disabled={!newChapterTitle.trim()}
                                        className={`px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2 shadow ${newChapterTitle.trim() ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'}`}
                                    >
                                        <Icons.Plus />
                                        Crear
                                    </button>
                                </div>
                                <p className="text-[11px] text-gray-600">Los nombres se pueden editar con el bot√≥n ‚ÄúRenombrar‚Äù. Usa mover para reorganizar antes de trabajar notas.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'chapter' && activeChapter) {
                return <NoteManager bookId={activeBookId} chapter={activeChapter} onBack={() => goBook(activeBookId)}
                    onAddNote={(text) => addNote(activeBookId, activeChapter.id, text)}
                    onUpdateNotes={(newNotes) => updateNotes(activeBookId, activeChapter.id, newNotes)}
                    editNote={editNote}
                    settings={settings} setLoading={setLoading} books={books} transferNote={transferNote} />;
            }
            return null;
        }

        // --- NOTE MANAGER (Optimized) ---
        function NoteManager({ bookId, chapter, onBack, onAddNote, onUpdateNotes, editNote, settings, setLoading, books, transferNote }) {
            const [isRecording, setIsRecording] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectionMode, setSelectionMode] = useState(false);
            const [manualText, setManualText] = useState("");
            const recognitionRef = useRef(null);
            const [supportError, setSupportError] = useState(null);

            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) setSupportError("Navegador sin soporte de voz");
                return () => { if (recognitionRef.current) recognitionRef.current.stop(); }
            }, []);

            const startRecording = () => {
                if (supportError) return alert(supportError);
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.onstart = () => setIsRecording(true);
                recognition.onresult = (event) => { if(event.results[0][0].transcript) onAddNote(event.results[0][0].transcript); };
                recognition.onerror = (event) => { console.error(event); setIsRecording(false); if(event.error === 'not-allowed') alert("Permiso de micr√≥fono denegado."); };
                recognition.onend = () => setIsRecording(false);
                recognition.start();
                recognitionRef.current = recognition;
            };

            const toggleRecording = () => isRecording ? recognitionRef.current?.stop() : startRecording();
            const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(sid => sid !== id) : [...prev, id]);

            const reorderNote = (id, direction) => {
                const index = chapter.notes.findIndex(n => n.id === id);
                const target = index + direction;
                if (target < 0 || target >= chapter.notes.length) return;
                onUpdateNotes(moveItem(chapter.notes, index, target));
            };

            const chooseDestination = () => {
                const options = books.flatMap(b => b.chapters.map(c => ({ label: `${b.title} ‚Üí ${c.title}`, bookId: b.id, chapterId: c.id })));
                if (options.length === 0) { alert('No hay cap√≠tulos destino.'); return null; }
                const list = options.map((o, idx) => `${idx + 1}. ${o.label}`).join('\n');
                const input = prompt(`Selecciona destino (n√∫mero)\n${list}`);
                const selected = options[Number(input) - 1];
                return selected;
            };

            const processAI = async (type, scope) => {
                const notes = scope === 'selection' ? chapter.notes.filter(n => selectedIds.includes(n.id)) : chapter.notes;
                if (notes.length === 0) return alert("Sin notas seleccionadas.");
                if (type === 'merge' && notes.length < 2) return alert("Selecciona 2+ notas.");

                const extraPrompt = type === 'style' ? prompt("Describe el estilo:") : type === 'generate' ? prompt("¬øQu√© necesitas generar?") : null;
                if ((type === 'style' || type === 'generate') && !extraPrompt) return;

                setLoading(true);
                try {
                    const text = notes.map(n => type === 'merge' ? `- ${n.content}` : n.content).join("\n\n");
                    let promptText = settings.prompts.merge;
                    if (type === 'style') promptText = settings.prompts.style.replace('{STYLE}', extraPrompt);
                    if (type === 'generate') promptText = `${settings.prompts.generate}\n\nPetici√≥n: ${extraPrompt}`;
                    const result = await callGemini(settings.apiKey, settings.model, promptText, text);

                    const newNote = { id: generateId(), content: result, timestamp: Date.now() };
                    if (scope === 'selection') {
                        const remaining = chapter.notes.filter(n => !selectedIds.includes(n.id));
                        onUpdateNotes([...remaining, newNote]);
                        setSelectedIds([]); setSelectionMode(false);
                    } else {
                        onUpdateNotes([newNote]);
                    }
                } catch (e) { alert(e.message); } finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex flex-col bg-gray-50">
                    <header className="glass-panel sticky top-0 z-10 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                        <div className="flex items-center gap-2">
                            <button onClick={onBack} className="p-1 rounded-full hover:bg-gray-100 text-gray-600"><Icons.ChevronLeft /></button>
                            <div className="overflow-hidden"><h1 className="text-lg font-bold text-gray-800 truncate">{chapter.title}</h1><p className="text-xs text-gray-500 truncate">{selectedIds.length} seleccionadas</p></div>
                        </div>
                        <button onClick={() => { setSelectionMode(!selectionMode); setSelectedIds([]); }} className={`text-xs px-3 py-1.5 rounded-full font-medium transition ${selectionMode ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}>{selectionMode ? 'Cancelar' : 'Seleccionar'}</button>
                    </header>

                    <main className="flex-1 p-4 pb-32 w-full max-w-md mx-auto">
                        <div className="mb-4 flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    {selectionMode && selectedIds.length > 1 && <button onClick={() => processAI('merge', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-green-50 text-green-700 px-3 py-2 rounded-lg border border-green-200 font-medium active:scale-95 transition" title="Fusiona y reemplaza la selecci√≥n por una sola nota"><Icons.Merge className="w-3 h-3" /> Fusionar</button>}
                    {selectionMode && selectedIds.length > 0 && <button onClick={() => processAI('style', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-purple-50 text-purple-700 px-3 py-2 rounded-lg border border-purple-200 font-medium active:scale-95 transition"><Icons.Wand className="w-3 h-3" /> Estilo (Sel)</button>}
                    {selectionMode && selectedIds.length > 0 && <button onClick={() => processAI('generate', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-amber-50 text-amber-700 px-3 py-2 rounded-lg border border-amber-200 font-medium active:scale-95 transition">üí° Generar</button>}
                    {!selectionMode && chapter.notes.length > 0 && <>
                        <button onClick={() => processAI('style', 'chapter')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg border border-indigo-200 font-medium active:scale-95 transition"><Icons.Wand className="w-3 h-3" /> Estilo (Todo)</button>
                        <button onClick={() => processAI('generate', 'chapter')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-amber-50 text-amber-700 px-3 py-2 rounded-lg border border-amber-200 font-medium active:scale-95 transition">üí° Generar cap√≠tulo</button>
                    </>}
                </div>

                        {chapter.notes.length === 0 && <div className="flex flex-col items-center justify-center h-64 text-gray-400"><Icons.Mic className="w-12 h-12 mb-2 opacity-20" /><p>Graba una nota</p></div>}

                        <div className="space-y-3">
                            {chapter.notes.map(note => (
                                <div key={note.id} onClick={() => selectionMode && toggleSelect(note.id)} className={`p-4 rounded-xl shadow-sm border transition relative ${selectedIds.includes(note.id) ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-400' : 'bg-white border-gray-100'}`}>
                                    <p className="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">{note.content}</p>
                                    <div className="mt-2 flex justify-between items-center text-[10px] text-gray-400">
                                        <span>{new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        {!selectionMode && <div className="flex items-center gap-1">
                                            <button onClick={(e) => { e.stopPropagation(); const updated = prompt('Editar nota', note.content); if(updated) editNote(bookId, chapter.id, note.id, updated.trim()); }} className="text-gray-400 hover:text-green-600 p-1">‚úé</button>
                                            <button onClick={(e) => { e.stopPropagation(); reorderNote(note.id, -1); }} className="text-gray-400 hover:text-blue-600 p-1">‚Üë</button>
                                            <button onClick={(e) => { e.stopPropagation(); reorderNote(note.id, 1); }} className="text-gray-400 hover:text-blue-600 p-1">‚Üì</button>
                                            <button onClick={(e) => { e.stopPropagation(); const dest = chooseDestination(); if(dest) transferNote(bookId, chapter.id, note.id, dest.bookId, dest.chapterId, 'move'); }} className="text-gray-400 hover:text-purple-600 p-1" title="Mover">‚áÑ</button>
                                            <button onClick={(e) => { e.stopPropagation(); const dest = chooseDestination(); if(dest) transferNote(bookId, chapter.id, note.id, dest.bookId, dest.chapterId, 'copy'); }} className="text-gray-400 hover:text-amber-600 p-1" title="Copiar">‚ßâ</button>
                                            <button onClick={(e) => { e.stopPropagation(); if(confirm("¬øBorrar?")) onUpdateNotes(chapter.notes.filter(n => n.id !== note.id)); }} className="text-gray-300 hover:text-red-500 p-1"><Icons.Trash /></button>
                                        </div>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </main>

                    <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-20 w-full max-w-md px-4">
                        <div className="bg-white border rounded-xl shadow p-3 space-y-2">
                            <textarea value={manualText} onChange={(e) => setManualText(e.target.value)} className="w-full border rounded-md p-2 text-sm" placeholder="Escribe una nota manualmente"></textarea>
                            <button onClick={() => { onAddNote(manualText); setManualText(''); }} className="w-full py-2 bg-slate-800 text-white rounded-md text-sm font-medium">Agregar nota de texto</button>
                            <p className="text-[11px] text-gray-500">Las notas de voz se limpian m√≠nimamente (may√∫sculas, espacios) y las fusiones reemplazan la selecci√≥n por una sola nota.</p>
                        </div>
                    </div>

                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center gap-2">
                        {isRecording && <p className="bg-black/70 text-white text-xs px-2 py-1 rounded whitespace-nowrap animate-pulse">Escuchando...</p>}
                        <button onClick={toggleRecording} disabled={!!supportError} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 ${isRecording ? 'bg-red-500 pulse-ring scale-110' : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'} ${supportError ? 'bg-gray-400 cursor-not-allowed' : ''}`}>
                            {isRecording ? <div className="w-6 h-6 bg-white rounded-sm" /> : <Icons.Mic className="text-white" />}
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


