<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VoiceNotes Manager</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel via CDN -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
      // Themes used to colour UI on different pages
      const THEMES = {
        home: { primary: 'blue', dark: 'blue-700', light: 'blue-100' },
        book: { primary: 'purple', dark: 'purple-700', light: 'purple-100' },
        chapter: { primary: 'green', dark: 'green-700', light: 'green-100' },
      };

      // Floating actions: a row of buttons centred at the bottom
      function FloatingActions({ onVoice, onText, theme }) {
        const [openText, setOpenText] = React.useState(false);
        const [textValue, setTextValue] = React.useState('');
        const primaryBg = `bg-${THEMES[theme].primary}-600`;
        const noteBg = `bg-${THEMES[theme].primary}-400`;
        return (
          <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 flex flex-col items-center gap-3">
            {openText && (
              <div className="mb-2 p-4 bg-white rounded-xl shadow-xl border w-64">
                <textarea
                  className="w-full h-24 p-2 border rounded mb-2"
                  placeholder="Escribe una nota..."
                  value={textValue}
                  onChange={(e) => setTextValue(e.target.value)}
                ></textarea>
                <div className="flex justify-end space-x-2">
                  <button
                    className="text-sm text-gray-600 hover:underline"
                    onClick={() => {
                      setTextValue('');
                      setOpenText(false);
                    }}
                  >Cancelar</button>
                  <button
                    className={`px-4 py-1 rounded text-white ${primaryBg}`}
                    onClick={() => {
                      if (textValue.trim()) onText(textValue.trim());
                      setTextValue('');
                      setOpenText(false);
                    }}
                  >Guardar</button>
                </div>
              </div>
            )}
            <div className="flex space-x-4">
              <button
                className={`p-4 rounded-full shadow-lg text-white ${noteBg}`}
                onClick={() => setOpenText(!openText)}
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
              </button>
              <button
                className={`p-4 rounded-full shadow-lg text-white ${primaryBg}`}
                onClick={onVoice}
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M12 3a3 3 0 00-3 3v4a3 3 0 006 0V6a3 3 0 00-3-3z" />
                  <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 9V6a7.5 7.5 0 00-15 0v3a7.5 7.5 0 0015 0zM12 19v2m0 0h-3m3 0h3" />
                </svg>
              </button>
            </div>
          </div>
        );
      }

      // Generic row for books or chapters
      function ItemRow({ item, index, totalCount, onSelect, onRename, onMoveUp, onMoveDown, onMove, onCopy, onDelete, theme }) {
        const [menuOpen, setMenuOpen] = React.useState(false);
        const [moveOpen, setMoveOpen] = React.useState(false);
        return (
          <div className="flex items-center justify-between py-2 px-3 bg-white border rounded-lg shadow-sm mb-2 hover:bg-gray-50 cursor-pointer" onClick={() => onSelect(item.id)}>
            <div className="flex-1">
              <div className="font-medium text-gray-800">{item.name}</div>
              {item.subtitle && <div className="text-sm text-gray-500">{item.subtitle}</div>}
            </div>
            <div className="relative" onClick={(e) => e.stopPropagation()}>
              <button
                className={`p-2 rounded-full text-${THEMES[theme].primary}-700 hover:bg-${THEMES[theme].light}`}
                onClick={() => setMenuOpen(!menuOpen)}
              >
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" className="w-4 h-4">
                  <path d="M2 8a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
              </button>
              {menuOpen && (
                <div className="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-20">
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onRename(item.id); }}>
                    Cambiar nombre
                  </button>
                  {index > 0 && (
                    <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onMoveUp(item.id); }}>
                      Mover arriba
                    </button>
                  )}
                  {index < totalCount - 1 && (
                    <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onMoveDown(item.id); }}>
                      Mover abajo
                    </button>
                  )}
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMoveOpen(!moveOpen); }}>
                    Mover a...
                  </button>
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMoveOpen(!moveOpen); }}>
                    Copiar a...
                  </button>
                  <button className="block w-full text-left px-3 py-2 text-red-600 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onDelete(item.id); }}>
                    Borrar
                  </button>
                  {/* Move/Copy dropdown; it will be populated externally */}
                  {moveOpen && (
                    <div className="border-t p-2 max-h-40 overflow-auto">
                      {item.moveOptions && item.moveOptions.length > 0 ? (
                        item.moveOptions.map((opt) => (
                          <div key={opt.id} className="px-2 py-1 hover:bg-gray-200 cursor-pointer" onClick={() => { setMenuOpen(false); setMoveOpen(false); onMove(item.id, opt.id); }}>
                            {opt.name}
                          </div>
                        ))
                      ) : (
                        <div className="px-2 py-1 text-gray-500">No options</div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      }

      // Component for a note card with menu actions
      function NoteCard({ note, index, totalCount, onEdit, onMoveUp, onMoveDown, onMove, onCopy, onDelete, theme }) {
        const [menuOpen, setMenuOpen] = React.useState(false);
        const [moveOpen, setMoveOpen] = React.useState(false);
        return (
          <div className="bg-white border rounded-lg shadow-sm p-3 mb-2 relative">
            <div className="mb-1 text-gray-800 whitespace-pre-wrap">{note.text}</div>
            <div className="text-xs text-gray-500">{new Date(note.timestamp).toLocaleString()}</div>
            <div className="absolute top-1 right-1">
              <button className={`p-1 rounded-full text-${THEMES[theme].primary}-700 hover:bg-${THEMES[theme].light}`} onClick={() => setMenuOpen(!menuOpen)}>
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" className="w-4 h-4">
                  <path d="M2 8a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
              </button>
              {menuOpen && (
                <div className="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg z-20">
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onEdit(note.id); }}>
                    Editar
                  </button>
                  {index > 0 && (
                    <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onMoveUp(note.id); }}>
                      Mover arriba
                    </button>
                  )}
                  {index < totalCount - 1 && (
                    <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onMoveDown(note.id); }}>
                      Mover abajo
                    </button>
                  )}
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => setMoveOpen(!moveOpen)}>
                    Mover a...
                  </button>
                  <button className="block w-full text-left px-3 py-2 hover:bg-gray-100" onClick={() => setMoveOpen(!moveOpen)}>
                    Copiar a...
                  </button>
                  <button className="block w-full text-left px-3 py-2 text-red-600 hover:bg-gray-100" onClick={() => { setMenuOpen(false); onDelete(note.id); }}>
                    Borrar
                  </button>
                  {moveOpen && (
                    <div className="border-t p-2 max-h-40 overflow-auto">
                      {note.moveOptions && note.moveOptions.length > 0 ? (
                        note.moveOptions.map((opt) => (
                          <div key={opt.id} className="px-2 py-1 hover:bg-gray-200 cursor-pointer" onClick={() => { setMenuOpen(false); setMoveOpen(false); onMove(note.id, opt.id); }}>
                            {opt.name}
                          </div>
                        ))
                      ) : (
                        <div className="px-2 py-1 text-gray-500">No options</div>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        );
      }

      function App() {
        const [view, setView] = React.useState('home'); // 'home', 'book', 'chapter'
        const [books, setBooks] = React.useState([]);
        const [currentBookId, setCurrentBookId] = React.useState(null);
        const [currentChapterId, setCurrentChapterId] = React.useState(null);
        // Helper to generate IDs
        const nextId = () => Math.random().toString(36).substr(2, 9);

        // Add new book
        const addBook = () => {
          const name = prompt('Nuevo libro:');
          if (name) {
            setBooks([...books, { id: nextId(), name, chapters: [], notes: [] }]);
          }
        };
        // Add new chapter to current book
        const addChapter = () => {
          const book = books.find((b) => b.id === currentBookId);
          if (!book) return;
          const name = prompt('Nuevo capítulo:');
          if (name) {
            const updatedBook = { ...book, chapters: [...book.chapters, { id: nextId(), name, notes: [] }] };
            setBooks(books.map((b) => (b.id === book.id ? updatedBook : b)));
          }
        };
        // Add note to current location
        const addNote = (text) => {
          const ts = Date.now();
          if (view === 'home') {
            // Quick note not associated with any book
            const quickNotesIndex = books.findIndex((b) => b.id === null);
          } else if (view === 'book') {
            setBooks(
              books.map((b) => {
                if (b.id === currentBookId) {
                  return { ...b, notes: [...(b.notes || []), { id: nextId(), text, timestamp: ts }] };
                }
                return b;
              })
            );
          } else if (view === 'chapter') {
            setBooks(
              books.map((b) => {
                if (b.id === currentBookId) {
                  const updatedChapters = b.chapters.map((c) => {
                    if (c.id === currentChapterId) {
                      return { ...c, notes: [...(c.notes || []), { id: nextId(), text, timestamp: ts }] };
                    }
                    return c;
                  });
                  return { ...b, chapters: updatedChapters };
                }
                return b;
              })
            );
          }
        };
        // Voice note stub
        const handleVoice = () => {
          alert('Voice input is not available in this demo.');
        };
        // Rename book or chapter
        const renameItem = (level, id) => {
          const newName = prompt('Nuevo nombre:');
          if (!newName) return;
          if (level === 'book') {
            setBooks(books.map((b) => (b.id === id ? { ...b, name: newName } : b)));
          } else if (level === 'chapter') {
            setBooks(
              books.map((b) => {
                if (b.id === currentBookId) {
                  return {
                    ...b,
                    chapters: b.chapters.map((c) => (c.id === id ? { ...c, name: newName } : c)),
                  };
                }
                return b;
              })
            );
          }
        };
        // Move up or down within list
        const moveItemUp = (level, id) => {
          if (level === 'book') {
            const idx = books.findIndex((b) => b.id === id);
            if (idx > 0) {
              const newBooks = [...books];
              [newBooks[idx - 1], newBooks[idx]] = [newBooks[idx], newBooks[idx - 1]];
              setBooks(newBooks);
            }
          } else if (level === 'chapter') {
            const book = books.find((b) => b.id === currentBookId);
            if (!book) return;
            const idx = book.chapters.findIndex((c) => c.id === id);
            if (idx > 0) {
              const newChapters = [...book.chapters];
              [newChapters[idx - 1], newChapters[idx]] = [newChapters[idx], newChapters[idx - 1]];
              const updatedBook = { ...book, chapters: newChapters };
              setBooks(books.map((b) => (b.id === book.id ? updatedBook : b)));
            }
          }
        };
        const moveItemDown = (level, id) => {
          if (level === 'book') {
            const idx = books.findIndex((b) => b.id === id);
            if (idx < books.length - 1) {
              const newBooks = [...books];
              [newBooks[idx], newBooks[idx + 1]] = [newBooks[idx + 1], newBooks[idx]];
              setBooks(newBooks);
            }
          } else if (level === 'chapter') {
            const book = books.find((b) => b.id === currentBookId);
            if (!book) return;
            const idx = book.chapters.findIndex((c) => c.id === id);
            if (idx < book.chapters.length - 1) {
              const newChapters = [...book.chapters];
              [newChapters[idx], newChapters[idx + 1]] = [newChapters[idx + 1], newChapters[idx]];
              const updatedBook = { ...book, chapters: newChapters };
              setBooks(books.map((b) => (b.id === book.id ? updatedBook : b)));
            }
          }
        };
        // Delete item
        const deleteItem = (level, id) => {
          if (!confirm('¿Estás seguro?')) return;
          if (level === 'book') {
            setBooks(books.filter((b) => b.id !== id));
          } else if (level === 'chapter') {
            setBooks(
              books.map((b) => {
                if (b.id === currentBookId) {
                  return { ...b, chapters: b.chapters.filter((c) => c.id !== id) };
                }
                return b;
              })
            );
          }
        };
        // Move item to another book or top level. For books level there is no higher level.
        const moveItem = (level, id, targetId) => {
          if (level === 'book') {
            // Not implemented: moving books between levels is not applicable
            return;
          } else if (level === 'chapter') {
            const bookFrom = books.find((b) => b.id === currentBookId);
            const chapter = bookFrom.chapters.find((c) => c.id === id);
            // remove from current
            const updatedSource = { ...bookFrom, chapters: bookFrom.chapters.filter((c) => c.id !== id) };
            // find target book
            const bookTo = books.find((b) => b.id === targetId);
            if (bookTo) {
              const updatedTarget = { ...bookTo, chapters: [...bookTo.chapters, chapter] };
              setBooks(
                books.map((b) => {
                  if (b.id === bookFrom.id) return updatedSource;
                  if (b.id === bookTo.id) return updatedTarget;
                  return b;
                })
              );
            }
          }
        };
        // Render home view: list of books
        const renderHome = () => {
          const theme = 'home';
          return (
            <div className="p-4">
              <h1 className="text-2xl font-bold mb-4 text-${THEMES.home.dark}">Mis Libros</h1>
              {books.length === 0 && <div className="text-gray-500">No tienes libros creados.</div>}
              {books.map((book, idx) => (
                <ItemRow
                  key={book.id}
                  item={book}
                  index={idx}
                  totalCount={books.length}
                  theme={theme}
                  onSelect={(id) => { setCurrentBookId(id); setView('book'); }}
                  onRename={(id) => renameItem('book', id)}
                  onMoveUp={(id) => moveItemUp('book', id)}
                  onMoveDown={(id) => moveItemDown('book', id)}
                  onMove={() => {}}
                  onCopy={() => {}}
                  onDelete={(id) => deleteItem('book', id)}
                  item={{ ...book, moveOptions: [] }}
                />
              ))}
              <FloatingActions
                onVoice={handleVoice}
                onText={(text) => addNote(text)}
                theme={theme}
              />
              <button
                className={`fixed bottom-20 right-4 px-4 py-2 rounded shadow text-white bg-${THEMES.home.primary}-600`}
                onClick={addBook}
              >
                + Nuevo Libro
              </button>
            </div>
          );
        };
        // Render book view: show notes and chapters
        const renderBook = () => {
          const book = books.find((b) => b.id === currentBookId);
          if (!book) return null;
          const theme = 'book';
          // Build move options for chapters: other books only (not itself)
          const chapterMoveOptions = books.filter((b) => b.id !== book.id).map((b) => ({ id: b.id, name: b.name }));
          return (
            <div className="p-4">
              <div className="flex items-center mb-4">
                <button className="mr-2 text-${THEMES.book.primary}-700" onClick={() => setView('home')}>&larr;</button>
                <h1 className="text-2xl font-bold text-${THEMES.book.dark}">{book.name}</h1>
              </div>
              {/* Notes belonging to book */}
              <div className="mb-4">
                <h2 className="font-semibold mb-2 text-${THEMES.book.dark}">Notas del libro</h2>
                {(!book.notes || book.notes.length === 0) && <div className="text-gray-500">Sin notas.</div>}
                {book.notes && book.notes.map((note, idx) => (
                  <NoteCard
                    key={note.id}
                    note={{ ...note, moveOptions: chapterMoveOptions }}
                    index={idx}
                    totalCount={book.notes.length}
                    theme={theme}
                    onEdit={(noteId) => {
                      const newText = prompt('Editar nota:', note.text);
                      if (newText !== null) {
                        setBooks(
                          books.map((b) => {
                            if (b.id === book.id) {
                              return {
                                ...b,
                                notes: b.notes.map((n) => (n.id === noteId ? { ...n, text: newText } : n)),
                              };
                            }
                            return b;
                          })
                        );
                      }
                    }}
                    onMoveUp={(noteId) => {
                      const idx2 = book.notes.findIndex((n) => n.id === noteId);
                      if (idx2 > 0) {
                        const newNotes = [...book.notes];
                        [newNotes[idx2 - 1], newNotes[idx2]] = [newNotes[idx2], newNotes[idx2 - 1]];
                        const updatedBook = { ...book, notes: newNotes };
                        setBooks(books.map((b) => (b.id === book.id ? updatedBook : b)));
                      }
                    }}
                    onMoveDown={(noteId) => {
                      const idx2 = book.notes.findIndex((n) => n.id === noteId);
                      if (idx2 < book.notes.length - 1) {
                        const newNotes = [...book.notes];
                        [newNotes[idx2], newNotes[idx2 + 1]] = [newNotes[idx2 + 1], newNotes[idx2]];
                        const updatedBook = { ...book, notes: newNotes };
                        setBooks(books.map((b) => (b.id === book.id ? updatedBook : b)));
                      }
                    }}
                    onMove={(noteId, targetBookId) => {
                      // Move note to chapter of another book not implemented. Could also move to book notes of another book.
                      const sourceNotes = book.notes.filter((n) => n.id !== noteId);
                      const movedNote = book.notes.find((n) => n.id === noteId);
                      setBooks(
                        books.map((b) => {
                          if (b.id === book.id) {
                            return { ...b, notes: sourceNotes };
                          }
                          if (b.id === targetBookId) {
                            return { ...b, notes: [...(b.notes || []), movedNote] };
                          }
                          return b;
                        })
                      );
                    }}
                    onCopy={(noteId, targetBookId) => {
                      const noteToCopy = book.notes.find((n) => n.id === noteId);
                      const copyNote = { ...noteToCopy, id: nextId(), timestamp: Date.now() };
                      setBooks(
                        books.map((b) => {
                          if (b.id === targetBookId) {
                            return { ...b, notes: [...(b.notes || []), copyNote] };
                          }
                          return b;
                        })
                      );
                    }}
                    onDelete={(noteId) => {
                      setBooks(
                        books.map((b) => {
                          if (b.id === book.id) {
                            return { ...b, notes: b.notes.filter((n) => n.id !== noteId) };
                          }
                          return b;
                        })
                      );
                    }}
                  />
                ))}
              </div>
              {/* Chapters list */}
              <div>
                <h2 className="font-semibold mb-2 text-${THEMES.book.dark}">Capítulos</h2>
                {book.chapters.length === 0 && <div className="text-gray-500">No hay capítulos.</div>}
                {book.chapters.map((chapter, idx) => (
                  <ItemRow
                    key={chapter.id}
                    item={{ ...chapter, moveOptions: chapterMoveOptions }}
                    index={idx}
                    totalCount={book.chapters.length}
                    theme={theme}
                    onSelect={(id) => { setCurrentChapterId(id); setView('chapter'); }}
                    onRename={(id) => renameItem('chapter', id)}
                    onMoveUp={(id) => moveItemUp('chapter', id)}
                    onMoveDown={(id) => moveItemDown('chapter', id)}
                    onMove={(id, targetBookId) => moveItem('chapter', id, targetBookId)}
                    onCopy={() => { alert('Copiar capítulo no implementado.'); }}
                    onDelete={(id) => deleteItem('chapter', id)}
                  />
                ))}
              </div>
              <FloatingActions
                onVoice={handleVoice}
                onText={(text) => addNote(text)}
                theme={theme}
              />
              <button
                className={`fixed bottom-20 right-4 px-4 py-2 rounded shadow text-white bg-${THEMES.book.primary}-600`}
                onClick={addChapter}
              >
                + Nuevo Capítulo
              </button>
            </div>
          );
        };
        // Render chapter view: show notes of selected chapter
        const renderChapter = () => {
          const book = books.find((b) => b.id === currentBookId);
          if (!book) return null;
          const chapter = book.chapters.find((c) => c.id === currentChapterId);
          if (!chapter) return null;
          const theme = 'chapter';
          // Move options for notes: other chapters within same book
          const noteMoveOptions = book.chapters
            .filter((c) => c.id !== chapter.id)
            .map((c) => ({ id: c.id, name: c.name }));
          return (
            <div className="p-4">
              <div className="flex items-center mb-4">
                <button className="mr-2 text-${THEMES.chapter.primary}-700" onClick={() => setView('book')}>&larr;</button>
                <h1 className="text-2xl font-bold text-${THEMES.chapter.dark}">{chapter.name}</h1>
              </div>
              {chapter.notes.length === 0 && <div className="text-gray-500">No hay notas. Usa el micrófono o escribe una nota.</div>}
              {chapter.notes.map((note, idx) => (
                <NoteCard
                  key={note.id}
                  note={{ ...note, moveOptions: noteMoveOptions }}
                  index={idx}
                  totalCount={chapter.notes.length}
                  theme={theme}
                  onEdit={(noteId) => {
                    const newText = prompt('Editar nota:', note.text);
                    if (newText !== null) {
                      setBooks(
                        books.map((b) => {
                          if (b.id === book.id) {
                            return {
                              ...b,
                              chapters: b.chapters.map((c) => {
                                if (c.id === chapter.id) {
                                  return {
                                    ...c,
                                    notes: c.notes.map((n) => (n.id === noteId ? { ...n, text: newText } : n)),
                                  };
                                }
                                return c;
                              }),
                            };
                          }
                          return b;
                        })
                      );
                    }
                  }}
                  onMoveUp={(noteId) => {
                    const idx2 = chapter.notes.findIndex((n) => n.id === noteId);
                    if (idx2 > 0) {
                      const newNotes = [...chapter.notes];
                      [newNotes[idx2 - 1], newNotes[idx2]] = [newNotes[idx2], newNotes[idx2 - 1]];
                      setBooks(
                        books.map((b) => {
                          if (b.id === book.id) {
                            return {
                              ...b,
                              chapters: b.chapters.map((c) => (c.id === chapter.id ? { ...c, notes: newNotes } : c)),
                            };
                          }
                          return b;
                        })
                      );
                    }
                  }}
                  onMoveDown={(noteId) => {
                    const idx2 = chapter.notes.findIndex((n) => n.id === noteId);
                    if (idx2 < chapter.notes.length - 1) {
                      const newNotes = [...chapter.notes];
                      [newNotes[idx2], newNotes[idx2 + 1]] = [newNotes[idx2 + 1], newNotes[idx2]];
                      setBooks(
                        books.map((b) => {
                          if (b.id === book.id) {
                            return {
                              ...b,
                              chapters: b.chapters.map((c) => (c.id === chapter.id ? { ...c, notes: newNotes } : c)),
                            };
                          }
                          return b;
                        })
                      );
                    }
                  }}
                  onMove={(noteId, targetChapterId) => {
                    const noteToMove = chapter.notes.find((n) => n.id === noteId);
                    // Remove from current
                    const updatedCurrentNotes = chapter.notes.filter((n) => n.id !== noteId);
                    // Add to target
                    setBooks(
                      books.map((b) => {
                        if (b.id === book.id) {
                          return {
                            ...b,
                            chapters: b.chapters.map((c) => {
                              if (c.id === chapter.id) {
                                return { ...c, notes: updatedCurrentNotes };
                              }
                              if (c.id === targetChapterId) {
                                return { ...c, notes: [...c.notes, noteToMove] };
                              }
                              return c;
                            }),
                          };
                        }
                        return b;
                      })
                    );
                  }}
                  onCopy={(noteId, targetChapterId) => {
                    const noteToCopy = chapter.notes.find((n) => n.id === noteId);
                    const copied = { ...noteToCopy, id: nextId(), timestamp: Date.now() };
                    setBooks(
                      books.map((b) => {
                        if (b.id === book.id) {
                          return {
                            ...b,
                            chapters: b.chapters.map((c) => {
                              if (c.id === targetChapterId) {
                                return { ...c, notes: [...c.notes, copied] };
                              }
                              return c;
                            }),
                          };
                        }
                        return b;
                      })
                    );
                  }}
                  onDelete={(noteId) => {
                    setBooks(
                      books.map((b) => {
                        if (b.id === book.id) {
                          return {
                            ...b,
                            chapters: b.chapters.map((c) => (c.id === chapter.id ? { ...c, notes: c.notes.filter((n) => n.id !== noteId) } : c)),
                          };
                        }
                        return b;
                      })
                    );
                  }}
                />
              ))}
              <FloatingActions
                onVoice={handleVoice}
                onText={(text) => addNote(text)}
                theme={theme}
              />
            </div>
          );
        };
        if (view === 'home') return renderHome();
        if (view === 'book') return renderBook();
        if (view === 'chapter') return renderChapter();
      }
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
