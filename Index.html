<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceNotes AI Manager</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root {
            --color-bg: #f1f5f9;
            --color-card: #ffffff;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        /* Estilos base y utilidades */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .safe-top {
            padding-top: env(safe-area-inset-top, 0);
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }

        .card {
            background: var(--color-card);
            border-radius: var(--radius-xl);
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
        }

        .card-tap {
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }
        .card-tap:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            padding: 0.35rem;
            font-size: 0.75rem;
        }
        .icon-btn-sm {
            padding: 0.25rem;
        }

        /* Animación de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animación de grabación */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-red 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-red {
            to { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }

        /* Scrollbar bonita */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(16px);
        }

        /* Estilos del editor y visualización de notas */
        .editor-content h1 {
            font-size: 12px;
            font-weight: 700;
            margin: 0 0 0.4rem;
        }
        .editor-content h2 {
            font-size: 10px;
            font-weight: 700;
            text-decoration: underline;
            margin: 0 0 0.3rem;
        }
        .editor-content p,
        .editor-content li {
            font-size: 12px;
            line-height: 1.5;
        }
        .editor-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin: 0.25rem 0 0.5rem;
        }
        .editor-content ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin: 0.25rem 0 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONOS SVG ---
        const Icons = {
            Book: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Folder: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
            Mic: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Wand: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="M3 21l9-9"/><path d="M12.2 6.2 11 5"/></svg>,
            Merge: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3"/><path d="M12 12.3v9.3"/><path d="m8 18 4 4 4-4"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        };

        // --- CONFIGURACIÓN INICIAL ---
        const DEFAULT_API_KEY = "";
        const DEFAULT_MODEL = "gemini-2.0-flash-exp";
        const DEFAULT_PROMPTS = {
            merge: "Combina las siguientes notas en un único texto coherente, bien estructurado y resumido. Usa Markdown para dar formato si es necesario.",
            style: "Reescribe el siguiente contenido aplicando estrictamente el siguiente estilo o tono: {STYLE}. Mantén la información original pero cambia la forma de expresarla.",
            generate: "Crea una nota nueva usando el siguiente contexto. Respeta el idioma y el nivel de detalle del material."
        };
        const TEMP_CHAPTER_TITLE = 'temporary';
        const TEMP_BOOK_TITLE = 'temp notes';

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        const moveItem = (array, from, to) => {
            const arr = [...array];
            const [item] = arr.splice(from, 1);
            arr.splice(to, 0, item);
            return arr;
        };
        const matchTitle = (value, target) => (value || '').trim().toLowerCase() === target;
        const cloneNote = (note) => ({ ...note, id: generateId(), timestamp: Date.now() });
        const escapeHtml = (text) => text.replace(/[&<>"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c]));
        const normalizeContent = (content) => {
            if (!content || typeof content !== 'string') return '<p></p>';
            const trimmed = content.trim();
            const looksLikeHtml = /<[^>]+>/.test(trimmed);
            if (looksLikeHtml) return trimmed;
            return `<p>${escapeHtml(trimmed).replace(/\n/g, '<br>')}</p>`;
        };
        const buildDestinations = (books, source) => {
            const options = [];

            const addBookScope = (book) => {
                options.push({ label: `${book.title} (Notas del libro)`, type: 'book', bookId: book.id });
                book.chapters.forEach(chapter => {
                    options.push({ label: `${book.title} → ${chapter.title}`, type: 'chapter', bookId: book.id, chapterId: chapter.id });
                });
            };

            if (!source || source.type !== 'root') {
                options.push({ label: 'Notas rápidas (inicio)', type: 'root' });
            }

            if (!source || source.type === 'root') {
                books.forEach(addBookScope);
                return options;
            }

            if (source.type === 'book') {
                books.forEach(book => {
                    if (book.id === source.bookId) {
                        addBookScope(book);
                    } else {
                        options.push({ label: `${book.title} (Notas del libro)`, type: 'book', bookId: book.id });
                    }
                });
                return options;
            }

            if (source.type === 'chapter') {
                const parentBook = books.find(b => b.id === source.bookId);
                if (parentBook) addBookScope(parentBook);
            }

            return options;
        };

        const useLongPressMoveMode = (duration = 500, { onEnterMoveMode } = {}) => {
            const [moveModeId, setMoveModeId] = useState(null);
            const pressTimer = useRef(null);
            const longPressTriggered = useRef(false);

            const clearPressTimer = () => {
                if (pressTimer.current) {
                    clearTimeout(pressTimer.current);
                    pressTimer.current = null;
                }
            };

            const startPress = (id) => {
                clearPressTimer();
                longPressTriggered.current = false;
                pressTimer.current = setTimeout(() => {
                    longPressTriggered.current = true;
                    setMoveModeId(prev => {
                        const nextId = prev === id ? null : id;
                        if (nextId) onEnterMoveMode?.(nextId);
                        return nextId;
                    });
                }, duration);
            };

            const cancelPress = () => {
                clearPressTimer();
            };

            const getItemProps = (id) => ({
                onPointerDown: () => startPress(id),
                onPointerUp: cancelPress,
                onPointerLeave: cancelPress,
                onPointerCancel: cancelPress,
                onClick: (e) => {
                    if (longPressTriggered.current) {
                        e.preventDefault();
                        e.stopPropagation();
                        longPressTriggered.current = false;
                    }
                },
            });

            useEffect(() => () => clearPressTimer(), []);

            const activateMoveMode = (id) => {
                setMoveModeId(prev => {
                    const nextId = id ?? null;
                    if (nextId && nextId !== prev) onEnterMoveMode?.(nextId);
                    return nextId;
                });
            };

            const exitMoveMode = () => {
                setMoveModeId(null);
                longPressTriggered.current = false;
                clearPressTimer();
            };

            return { moveModeId, getItemProps, exitMoveMode, activateMoveMode };
        };

        const NoteEditorModal = ({ isOpen, title, value, onChange, onSave, onClose }) => {
            const editorRef = useRef(null);
            const [fontFamily, setFontFamily] = useState('Calibri');
            const [fontSize, setFontSize] = useState(12);
            const [highlightColor, setHighlightColor] = useState('#fff59d');
            const [textColor, setTextColor] = useState('#1d4ed8');
            const [activeFormats, setActiveFormats] = useState({
                bold: false,
                italic: false,
                underline: false,
                unorderedList: false,
                orderedList: false,
                alignLeft: true,
                alignCenter: false,
                alignRight: false,
                alignJustify: false,
                highlight: false,
                textColor: false,
            });

            useEffect(() => {
                if (isOpen && editorRef.current) {
                    if (value && editorRef.current.innerHTML !== value) {
                        editorRef.current.innerHTML = value;
                    } else if (!value) {
                        editorRef.current.innerHTML = '<p></p>';
                    }
                    editorRef.current.focus();
                    syncCommandStates();
                }
            }, [isOpen, value]);

            useEffect(() => {
                if (!isOpen) return;
                const handleSelectionChange = () => syncCommandStates();
                document.addEventListener('selectionchange', handleSelectionChange);
                return () => document.removeEventListener('selectionchange', handleSelectionChange);
            }, [isOpen]);

            const normalizeHex = (value) => {
                if (!value) return '';
                const temp = document.createElement('div');
                temp.style.color = value;
                document.body.appendChild(temp);
                const rgb = getComputedStyle(temp).color;
                document.body.removeChild(temp);

                const match = rgb.match(/(\d+)/g);
                if (!match) return value.toLowerCase();
                const toHex = (n) => Number(n).toString(16).padStart(2, '0');
                const [r, g, b] = match;
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            };

            const colorsEqual = (a, b) => normalizeHex(a) === normalizeHex(b);

            const syncCommandStates = () => {
                if (!editorRef.current) return;
                const highlightValue = document.queryCommandValue('hiliteColor');
                const textColorValue = document.queryCommandValue('foreColor');

                setActiveFormats({
                    bold: document.queryCommandState('bold'),
                    italic: document.queryCommandState('italic'),
                    underline: document.queryCommandState('underline'),
                    unorderedList: document.queryCommandState('insertUnorderedList'),
                    orderedList: document.queryCommandState('insertOrderedList'),
                    alignLeft: document.queryCommandState('justifyLeft'),
                    alignCenter: document.queryCommandState('justifyCenter'),
                    alignRight: document.queryCommandState('justifyRight'),
                    alignJustify: document.queryCommandState('justifyFull'),
                    highlight: colorsEqual(highlightValue, highlightColor),
                    textColor: colorsEqual(textColorValue, textColor),
                });
            };

            const format = (command, arg = null) => {
                if (!editorRef.current) return;
                document.execCommand(command, false, arg);
                editorRef.current.focus();
                onChange(editorRef.current.innerHTML);
                syncCommandStates();
            };

            const applyFontFamily = (family) => {
                setFontFamily(family);
                format('fontName', family);
            };

            const applyFontSize = (size) => {
                if (!editorRef.current) return;
                setFontSize(size);
                const sizeMap = { 10: 2, 11: 2, 12: 3, 14: 4, 16: 5, 18: 6, 20: 7 };
                const commandSize = sizeMap[size] || 3;
                document.execCommand('fontSize', false, commandSize);

                const fonts = editorRef.current.getElementsByTagName('font');
                Array.from(fonts).forEach((font) => {
                    if (font.size == commandSize) {
                        font.removeAttribute('size');
                        font.style.fontSize = `${size}px`;
                    }
                });

                editorRef.current.focus();
                onChange(editorRef.current.innerHTML);
            };

            const applyHighlight = (color) => {
                const current = document.queryCommandValue('hiliteColor');
                const shouldClear = colorsEqual(current, color);
                setHighlightColor(color);
                format('hiliteColor', shouldClear ? 'transparent' : color);
            };

            const applyTextColor = (color) => {
                const current = document.queryCommandValue('foreColor');
                const shouldClear = colorsEqual(current, color);
                setTextColor(color);
                format('foreColor', shouldClear ? '#000000' : color);
            };

            const handleInput = () => {
                if (editorRef.current) onChange(editorRef.current.innerHTML);
                syncCommandStates();
            };

            const toolbarButtonClass = "px-2 py-1 rounded-md border bg-white shadow-sm text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-1";
            const activeToolbarClass = "bg-blue-50 border-blue-500 text-blue-700 shadow-inner";
            const getButtonClasses = (isActive = false) => `${toolbarButtonClass} ${isActive ? activeToolbarClass : ''}`;

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-slate-900/60 backdrop-blur flex flex-col">
                    <div className="flex items-center justify-between p-4 bg-white shadow-md border-b">
                        <div>
                            <p className="text-xs uppercase tracking-wide text-slate-400">Editor de nota</p>
                            <p className="text-sm font-semibold text-slate-900">{title}</p>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg border text-slate-700 hover:bg-slate-50">Cancelar</button>
                            <button onClick={onSave} className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">Guardar</button>
                        </div>
                    </div>
                    <div className="px-4 py-3 bg-slate-50 border-b space-y-2">
                        <div className="flex flex-wrap items-center gap-2">
                            <select
                                value={fontFamily}
                                onChange={(e) => applyFontFamily(e.target.value)}
                                className="h-9 rounded-md border bg-white px-2 text-sm shadow-sm"
                            >
                                {['Calibri', 'Arial', 'Georgia', 'Times New Roman', 'Segoe UI', 'Roboto'].map((font) => (
                                    <option key={font} value={font}>{font}</option>
                                ))}
                            </select>
                            <select
                                value={fontSize}
                                onChange={(e) => applyFontSize(Number(e.target.value))}
                                className="h-9 rounded-md border bg-white px-2 text-sm shadow-sm"
                            >
                                {[10, 11, 12, 14, 16, 18, 20].map((size) => (
                                    <option key={size} value={size}>{size}</option>
                                ))}
                            </select>
                            <button
                                onClick={() => applyHighlight('#fff59d')}
                                className={getButtonClasses(activeFormats.highlight)}
                                title="Resaltar"
                            >
                                <span className="inline-flex h-4 w-4 rounded-sm border" style={{ backgroundColor: highlightColor }}></span>
                                <span>Resaltar</span>
                            </button>
                            <button
                                onClick={() => applyTextColor('#2563eb')}
                                className={getButtonClasses(activeFormats.textColor)}
                                title="Color de texto"
                            >
                                <span className="inline-flex h-4 w-4 rounded-sm border" style={{ backgroundColor: textColor }}></span>
                                <span>Color</span>
                            </button>
                        </div>

                        <div className="flex flex-wrap items-center gap-1">
                            <button onClick={() => format('bold')} className={getButtonClasses(activeFormats.bold) + ' font-semibold'}><strong>B</strong></button>
                            <button onClick={() => format('italic')} className={getButtonClasses(activeFormats.italic) + ' italic'}>I</button>
                            <button onClick={() => format('underline')} className={getButtonClasses(activeFormats.underline) + ' underline'}>U</button>
                        </div>

                        <div className="flex flex-wrap items-center gap-1">
                            <button onClick={() => format('justifyLeft')} className={getButtonClasses(activeFormats.alignLeft)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M4 6h16" /><path d="M4 10h10" /><path d="M4 14h16" /><path d="M4 18h10" />
                                </svg>
                                <span className="sr-only">Alinear a la izquierda</span>
                            </button>
                            <button onClick={() => format('justifyCenter')} className={getButtonClasses(activeFormats.alignCenter)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M6 6h12" /><path d="M4 10h16" /><path d="M6 14h12" /><path d="M4 18h16" />
                                </svg>
                                <span className="sr-only">Centrar</span>
                            </button>
                            <button onClick={() => format('justifyRight')} className={getButtonClasses(activeFormats.alignRight)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M4 6h16" /><path d="M10 10h10" /><path d="M4 14h16" /><path d="M10 18h10" />
                                </svg>
                                <span className="sr-only">Alinear a la derecha</span>
                            </button>
                            <button onClick={() => format('justifyFull')} className={getButtonClasses(activeFormats.alignJustify)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M4 6h16" /><path d="M4 10h16" /><path d="M4 14h16" /><path d="M4 18h16" />
                                </svg>
                                <span className="sr-only">Justificar</span>
                            </button>
                            <button onClick={() => format('insertUnorderedList')} className={getButtonClasses(activeFormats.unorderedList)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <circle cx="5" cy="6" r="1" /><circle cx="5" cy="12" r="1" /><circle cx="5" cy="18" r="1" />
                                    <path d="M9 6h10" /><path d="M9 12h10" /><path d="M9 18h10" />
                                </svg>
                                <span className="sr-only">Lista con viñetas</span>
                            </button>
                            <button onClick={() => format('insertOrderedList')} className={getButtonClasses(activeFormats.orderedList)}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M5 5h2" /><path d="M6 4v6" /><path d="M5 11h2" /><path d="M4 14h2l-2 3h3" /><path d="M4 20h3" />
                                    <path d="M9 6h10" /><path d="M9 12h10" /><path d="M9 18h10" />
                                </svg>
                                <span className="sr-only">Lista numerada</span>
                            </button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto bg-white">
                        <div
                            ref={editorRef}
                            contentEditable
                            onInput={handleInput}
                            className="max-w-4xl mx-auto p-6 min-h-[60vh] prose prose-slate focus:outline-none editor-content"
                            placeholder="Escribe o pega tu nota con formato..."
                        ></div>
                    </div>
                </div>
            );
        };

        const MoveControls = ({ onMoveUp, onMoveDown, accentClass = 'text-slate-700' }) => (
            <div className="flex flex-col items-center justify-center gap-1 bg-white/90 rounded-full border border-slate-200 shadow-sm p-1">
                <button
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => { e.stopPropagation(); onMoveUp?.(); }}
                    className={`w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100 active:scale-95 ${accentClass}`}
                    aria-label="Mover hacia arriba"
                >
                    ▲
                </button>
                <button
                    onPointerDown={(e) => e.stopPropagation()}
                    onClick={(e) => { e.stopPropagation(); onMoveDown?.(); }}
                    className={`w-8 h-8 rounded-full flex items-center justify-center hover:bg-slate-100 active:scale-95 ${accentClass}`}
                    aria-label="Mover hacia abajo"
                >
                    ▼
                </button>
            </div>
        );

        const NoteChip = ({ note, actions = {}, selectionMode = false, isSelected = false, onCardClick, moveHandlers = {}, moveModeActive = false }) => {
            const [menuOpen, setMenuOpen] = useState(false);
            const [menuDirection, setMenuDirection] = useState('up');
            const menuButtonRef = useRef(null);
            const { onEdit, onDelete, onMove, onCopy, onMoveUp, onMoveDown } = actions;
            const hasActions = moveModeActive || onEdit || onDelete || onMove || onCopy || onMoveUp || onMoveDown;

            const handleAction = (callback) => {
                if (callback) callback();
                setMenuOpen(false);
            };

            return (
                <div
                    {...moveHandlers}
                    className={`p-4 rounded-xl shadow-sm border transition relative cursor-pointer select-none ${isSelected ? 'bg-blue-50 border-blue-400 ring-1 ring-blue-400' : 'bg-white border-gray-100'}`}
                    onClick={(e) => {
                        moveHandlers.onClick?.(e);
                        if (e.defaultPrevented) return;
                        onCardClick?.(e);
                    }}
                >
                    <div className="text-sm text-gray-800 prose prose-slate max-w-none leading-relaxed editor-content" dangerouslySetInnerHTML={{ __html: note.content }} />
                    <div className="mt-2 flex justify-between items-center text-[10px] text-gray-400">
                        <span>{new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        {hasActions && (
                            <div className="relative">
                                {moveModeActive ? (
                                    <MoveControls onMoveUp={onMoveUp} onMoveDown={onMoveDown} />
                                ) : (
                                    <>
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                const rect = e.currentTarget.getBoundingClientRect();
                                                setMenuDirection(rect.top >= window.innerHeight / 2 ? 'up' : 'down');
                                                setMenuOpen(o => !o);
                                            }}
                                            className="w-9 h-9 rounded-full text-white shadow-md flex items-center justify-center bg-slate-600 hover:bg-slate-700"
                                            title="Opciones de nota"
                                            ref={menuButtonRef}
                                        >
                                            <Icons.Edit />
                                        </button>
                                        {menuOpen && (
                                            <div className={`absolute right-0 ${menuDirection === 'up' ? 'bottom-12' : 'top-12'} w-48 bg-white border rounded-xl shadow-xl z-30 overflow-hidden`}>
                                                {onEdit && <button onClick={(e) => { e.stopPropagation(); handleAction(onEdit); }} className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50">Editar</button>}
                                                {onMoveUp && <button onClick={(e) => { e.stopPropagation(); handleAction(onMoveUp); }} className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50">Subir</button>}
                                                {onMoveDown && <button onClick={(e) => { e.stopPropagation(); handleAction(onMoveDown); }} className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50">Bajar</button>}
                                                {onMove && <button onClick={(e) => { e.stopPropagation(); handleAction(onMove); }} className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50">Mover</button>}
                                                {onCopy && <button onClick={(e) => { e.stopPropagation(); handleAction(onCopy); }} className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50">Copiar</button>}
                                                {onDelete && <button onClick={(e) => { e.stopPropagation(); handleAction(onDelete); }} className="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50">Eliminar</button>}
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ActionMenu = ({ colorClass = 'bg-slate-600', onToggle = () => {}, options = [] }) => {
            const [open, setOpen] = useState(false);
            const [direction, setDirection] = useState('up');
            const triggerRef = useRef(null);

            const handleOption = (action) => {
                action();
                setOpen(false);
            };

            return (
                <div className="relative">
                    <button
                        onClick={(e) => {
                            e.stopPropagation();
                            const rect = e.currentTarget.getBoundingClientRect();
                            setDirection(rect.top >= window.innerHeight / 2 ? 'up' : 'down');
                            setOpen(o => !o);
                            onToggle();
                        }}
                        className={`w-9 h-9 rounded-full text-white shadow-md flex items-center justify-center ${colorClass}`}
                        title="Opciones"
                        ref={triggerRef}
                    >
                        <Icons.Edit />
                    </button>
                    {open && (
                        <div className={`absolute right-0 ${direction === 'up' ? 'bottom-12' : 'top-12'} w-48 bg-white border rounded-xl shadow-xl z-30 overflow-hidden`}>
                            {options.map(opt => (
                                <button
                                    key={opt.label}
                                    onClick={(e) => { e.stopPropagation(); handleOption(opt.onClick); }}
                                    className="w-full px-3 py-2 text-left text-sm text-slate-700 hover:bg-slate-50 flex items-center justify-between"
                                >
                                    <span>{opt.label}</span>
                                    {opt.badge && <span className="text-[10px] text-slate-400">{opt.badge}</span>}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const OptionPicker = ({ state, onSelect, onClose }) => {
            if (!state.open) return null;
            return (
                <div className="fixed inset-0 z-40 flex items-center justify-center bg-black/40 p-4" onClick={onClose}>
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl border p-4" onClick={(e) => e.stopPropagation()}>
                        <div className="flex items-center justify-between mb-3">
                            <p className="text-sm font-semibold text-slate-800">{state.title || 'Selecciona una opción'}</p>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600">✕</button>
                        </div>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                            {state.options.map((opt, idx) => (
                                <button
                                    key={`${opt.label}-${idx}`}
                                    onClick={() => onSelect(opt)}
                                    className="w-full text-left px-3 py-2 rounded-xl border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition"
                                >
                                    {opt.label}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- API GEMINI ---
        async function callGemini(apiKey, model, prompt, content) {
            if (!apiKey || apiKey.length < 10) throw new Error("Falta la API Key.");

            // Usar el modelo configurado
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const fullText = `${prompt}\n\n--- CONTENIDO ---\n${content}`;
            const payload = { contents: [{ parts: [{ text: fullText }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.error?.code === 404) {
                        throw new Error(`Modelo '${model}' no encontrado. Revisa el nombre en Configuración.`);
                    }
                    throw new Error(data.error?.message || 'Error desconocido en la API');
                }

                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se generó respuesta.";
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [books, setBooks] = useState([]);
            const [rootNotes, setRootNotes] = useState([]);
            const [settings, setSettings] = useState({
                apiKey: DEFAULT_API_KEY,
                model: DEFAULT_MODEL,
                prompts: { ...DEFAULT_PROMPTS }
            });
            const [view, setView] = useState('home');
            const [activeBookId, setActiveBookId] = useState(null);
            const [activeChapterId, setActiveChapterId] = useState(null);
            const [loading, setLoading] = useState(false);
            const [testStatus, setTestStatus] = useState(null); // null, 'loading', 'success', 'error'
            const [testMsg, setTestMsg] = useState("");
            const [editingBook, setEditingBook] = useState({ id: null, title: "" });
            const [editingChapter, setEditingChapter] = useState({ id: null, title: "" });
            const [selectedBookIds, setSelectedBookIds] = useState([]);
            const [bookSelectionMode, setBookSelectionMode] = useState(false);
            const [activeSelectedBookId, setActiveSelectedBookId] = useState(null);
            const [selectedChapterIds, setSelectedChapterIds] = useState([]);
            const [chapterSelectionMode, setChapterSelectionMode] = useState(false);
            const [activeSelectedChapterId, setActiveSelectedChapterId] = useState(null);
            const [noteModal, setNoteModal] = useState({ open: false, target: null });
            const [noteDraft, setNoteDraft] = useState('<p></p>');
            const recognitionRef = useRef(null);
            const [recordingTarget, setRecordingTarget] = useState(null);
            const [isRecording, setIsRecording] = useState(false);
            const [micSupportError, setMicSupportError] = useState(null);
            const [picker, setPicker] = useState({ open: false, options: [], title: '', resolve: null });

            useEffect(() => {
                const savedBooks = localStorage.getItem('voiceNotes_books');
                const savedSettings = localStorage.getItem('voiceNotes_settings');
                if (savedBooks) {
                    const parsed = JSON.parse(savedBooks);
                    const normalized = parsed.map(b => ({
                        ...b,
                        notes: b.notes || [],
                        chapters: (b.chapters || []).map(c => ({ ...c, notes: c.notes || [] }))
                    }));
                    setBooks(normalized);
                }
                const savedRoot = localStorage.getItem('voiceNotes_rootNotes');
                if (savedRoot) setRootNotes(JSON.parse(savedRoot));
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    setSettings({
                        apiKey: parsed.apiKey || DEFAULT_API_KEY,
                        model: parsed.model || DEFAULT_MODEL,
                        prompts: { ...DEFAULT_PROMPTS, ...(parsed.prompts || {}) }
                    });
                }
            }, []);

            useEffect(() => { localStorage.setItem('voiceNotes_books', JSON.stringify(books)); }, [books]);
            useEffect(() => { localStorage.setItem('voiceNotes_settings', JSON.stringify(settings)); }, [settings]);
            useEffect(() => { localStorage.setItem('voiceNotes_rootNotes', JSON.stringify(rootNotes)); }, [rootNotes]);
            useEffect(() => { setEditingChapter({ id: null, title: "" }); }, [activeBookId]);

            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    setMicSupportError("Navegador sin soporte de voz");
                }
                return () => { if (recognitionRef.current) recognitionRef.current.stop(); };
            }, []);

            // Helpers de navegación y datos
            const addBook = (title) => setBooks([...books, { id: generateId(), title, chapters: [], notes: [] }]);
            const renameBook = (id, title) => setBooks(books.map(b => b.id === id ? { ...b, title } : b));
            const deleteBook = (id) => setBooks(books.filter(b => b.id !== id));
            const reorderBooksByIndex = useCallback((from, to) => {
                setBooks(prev => moveItem(prev, from, to));
            }, []);
            const reorderBook = (id, direction) => {
                const index = books.findIndex(b => b.id === id);
                const target = index + direction;
                if (target < 0 || target >= books.length) return;
                setBooks(moveItem(books, index, target));
            };
            const moveBookToPosition = async (bookId) => {
                if (books.length < 2) return;
                const options = books
                    .filter(b => b.id !== bookId)
                    .map((b, idx) => ({ label: `Después de ${b.title}`, value: idx + 1 }));
                options.unshift({ label: 'Al inicio', value: 0 });
                const choice = await openPickerWithOptions(options, 'Mover libro');
                if (!choice || typeof choice.value !== 'number') return;
                const fromIndex = books.findIndex(b => b.id === bookId);
                const list = [...books];
                const [item] = list.splice(fromIndex, 1);
                let targetIndex = choice.value;
                if (targetIndex > fromIndex) targetIndex -= 1;
                list.splice(targetIndex, 0, item);
                setBooks(list);
            };
            const duplicateBook = (bookId) => {
                const book = books.find(b => b.id === bookId);
                if (!book) return;
                const copy = {
                    ...book,
                    id: generateId(),
                    title: `${book.title} (copia)`,
                    notes: (book.notes || []).map(cloneNote),
                    chapters: book.chapters.map(ch => ({
                        ...ch,
                        id: generateId(),
                        notes: ch.notes.map(cloneNote)
                    }))
                };
                setBooks([...books, copy]);
            };
            const addChapter = (bookId, title) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: [...b.chapters, { id: generateId(), title, notes: [] }] } : b));
            };
            const renameChapter = (bookId, chapterId, title) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, title } : c) } : b));
            };
            const reorderChaptersByIndex = useCallback((bookId, from, to) => {
                setBooks(prev => prev.map(b => b.id === bookId ? { ...b, chapters: moveItem(b.chapters, from, to) } : b));
            }, []);
            const addNote = (bookId, chapterId, content) => {
                if (!content || !content.trim()) return;
                const cleanContent = normalizeContent(content);
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: [...c.notes, { id: generateId(), content: cleanContent, timestamp: Date.now() }] } : c) } : b));
            };
            const addBookNote = (bookId, content) => {
                if (!content || !content.trim()) return;
                const cleanContent = normalizeContent(content);
                let tempChapterId = null;
                setBooks(prevBooks => prevBooks.map(book => {
                    if (book.id !== bookId) return book;
                    const note = { id: generateId(), content: cleanContent, timestamp: Date.now() };
                    const temporary = book.chapters.find(c => matchTitle(c.title, TEMP_CHAPTER_TITLE));
                    if (temporary) {
                        tempChapterId = temporary.id;
                        return {
                            ...book,
                            chapters: book.chapters.map(c => c.id === temporary.id ? { ...c, notes: [...c.notes, note] } : c)
                        };
                    }
                    const newChapterId = generateId();
                    tempChapterId = newChapterId;
                    return {
                        ...book,
                        chapters: [...book.chapters, { id: newChapterId, title: TEMP_CHAPTER_TITLE, notes: [note] }]
                    };
                }));

                if (tempChapterId) {
                    setActiveBookId(bookId);
                    goChapter(tempChapterId);
                }
            };
            const addRootNote = (content) => {
                if (!content || !content.trim()) return;
                const cleanContent = normalizeContent(content);
                let targetBookId = null;
                let tempChapterId = null;
                setBooks(prevBooks => {
                    let updatedBooks = [...prevBooks];
                    let tempBook = updatedBooks.find(b => matchTitle(b.title, TEMP_BOOK_TITLE));
                    if (!tempBook) {
                        tempBook = { id: generateId(), title: TEMP_BOOK_TITLE, chapters: [], notes: [] };
                        updatedBooks = [...updatedBooks, tempBook];
                    }
                    targetBookId = tempBook.id;
                    const note = { id: generateId(), content: cleanContent, timestamp: Date.now() };
                    const temporary = tempBook.chapters.find(c => matchTitle(c.title, TEMP_CHAPTER_TITLE));
                    if (temporary) {
                        tempChapterId = temporary.id;
                        updatedBooks = updatedBooks.map(b => b.id === tempBook.id
                            ? { ...tempBook, chapters: tempBook.chapters.map(c => c.id === temporary.id ? { ...c, notes: [...c.notes, note] } : c) }
                            : b);
                    } else {
                        tempChapterId = generateId();
                        const newChapter = { id: tempChapterId, title: TEMP_CHAPTER_TITLE, notes: [note] };
                        updatedBooks = updatedBooks.map(b => b.id === tempBook.id
                            ? { ...tempBook, chapters: [...tempBook.chapters, newChapter] }
                            : b);
                    }
                    return updatedBooks;
                });

                if (targetBookId && tempChapterId) {
                    setActiveBookId(targetBookId);
                    goChapter(tempChapterId);
                }
            };
            const reorderRootNotesByIndex = useCallback((from, to) => {
                setRootNotes(prev => moveItem(prev, from, to));
            }, []);
            const reorderRootNote = (noteId, direction) => {
                const index = rootNotes.findIndex(n => n.id === noteId);
                if (index < 0) return;
                const target = index + direction;
                if (target < 0 || target >= rootNotes.length) return;
                setRootNotes(moveItem(rootNotes, index, target));
            };
            const reorderBookNote = (bookId, noteId, direction) => {
                const book = books.find(b => b.id === bookId);
                if (!book) return;
                const index = book.notes?.findIndex(n => n.id === noteId) ?? -1;
                if (index < 0) return;
                const target = index + direction;
                if (target < 0 || !book.notes || target >= book.notes.length) return;
                updateBookNotes(bookId, moveItem(book.notes, index, target));
            };
            const reorderBookNotesByIndex = useCallback((bookId, from, to) => {
                setBooks(prev => prev.map(b => b.id === bookId ? { ...b, notes: moveItem(b.notes || [], from, to) } : b));
            }, []);
            const chooseDestination = async (source) => {
                const options = buildDestinations(books, source);
                if (options.length === 0) { alert('No hay destinos disponibles.'); return null; }
                return await openPickerWithOptions(options, 'Elige dónde guardar');
            };
            const relocateNote = (source, destination, noteId, mode = 'move') => {
                const findNote = () => {
                    if (source.type === 'root') return rootNotes.find(n => n.id === noteId);
                    if (source.type === 'book') return books.find(b => b.id === source.bookId)?.notes?.find(n => n.id === noteId);
                    if (source.type === 'chapter') return books.find(b => b.id === source.bookId)?.chapters.find(c => c.id === source.chapterId)?.notes.find(n => n.id === noteId);
                    return null;
                };
                const note = findNote();
                if (!note) return;
                const noteForDestination = mode === 'copy' ? cloneNote(note) : note;

                if (destination.type === 'root') {
                    if (mode === 'move' && source.type === 'root') {
                        setRootNotes(prev => [...prev.filter(n => n.id !== noteId), noteForDestination]);
                    } else {
                        setRootNotes(prev => [...prev, noteForDestination]);
                    }
                }

                setBooks(prevBooks => prevBooks.map(book => {
                    let updatedBook = book;

                    // Eliminar del origen si corresponde
                    if (mode === 'move') {
                        if (source.type === 'book' && book.id === source.bookId) {
                            updatedBook = { ...updatedBook, notes: (updatedBook.notes || []).filter(n => n.id !== noteId) };
                        }
                        if (source.type === 'chapter' && book.id === source.bookId) {
                            updatedBook = {
                                ...updatedBook,
                                chapters: updatedBook.chapters.map(c => c.id === source.chapterId ? { ...c, notes: c.notes.filter(n => n.id !== noteId) } : c)
                            };
                        }
                    }

                    // Agregar al destino
                    if (destination.type === 'book' && book.id === destination.bookId) {
                        updatedBook = { ...updatedBook, notes: [...(updatedBook.notes || []), noteForDestination] };
                    }
                    if (destination.type === 'chapter' && book.id === destination.bookId) {
                        updatedBook = {
                            ...updatedBook,
                            chapters: updatedBook.chapters.map(c => c.id === destination.chapterId ? { ...c, notes: [...c.notes, noteForDestination] } : c)
                        };
                    }

                    return updatedBook;
                }));

                if (source.type === 'root' && mode === 'move' && destination.type !== 'root') setRootNotes(prev => prev.filter(n => n.id !== noteId));
            };
            const editNote = (bookId, chapterId, noteId, content) => {
                const cleanContent = normalizeContent(content);
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: c.notes.map(n => n.id === noteId ? { ...n, content: cleanContent } : n) } : c) } : b));
            };
            const updateNotes = (bookId, chapterId, newNotes) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.map(c => c.id === chapterId ? { ...c, notes: newNotes } : c) } : b));
            };
            const updateBookNotes = (bookId, newNotes) => setBooks(books.map(b => b.id === bookId ? { ...b, notes: newNotes } : b));
            const updateBookChapters = (bookId, newChapters) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: newChapters } : b));
            };
            const deleteChapter = (bookId, chapterId) => {
                setBooks(books.map(b => b.id === bookId ? { ...b, chapters: b.chapters.filter(c => c.id !== chapterId) } : b));
            };
            const reorderChapter = (bookId, chapterId, direction) => {
                const book = books.find(b => b.id === bookId);
                const index = book?.chapters.findIndex(c => c.id === chapterId);
                if (index === undefined || index < 0) return;
                const target = index + direction;
                if (target < 0 || !book || target >= book.chapters.length) return;
                const newChapters = moveItem(book.chapters, index, target);
                updateBookChapters(bookId, newChapters);
            };
            const copyChapterToBook = (sourceBookId, chapterId, targetBookId) => {
                const source = books.find(b => b.id === sourceBookId);
                const target = books.find(b => b.id === targetBookId);
                if (!source || !target) return;
                const chapter = source.chapters.find(c => c.id === chapterId);
                if (!chapter) return;
                const cloned = { ...chapter, id: generateId(), notes: chapter.notes.map(cloneNote) };
                setBooks(books.map(b => b.id === targetBookId ? { ...b, chapters: [...b.chapters, cloned] } : b));
            };
            const moveChapterToBook = (sourceBookId, chapterId, targetBookId) => {
                if (sourceBookId === targetBookId) return;
                const source = books.find(b => b.id === sourceBookId);
                const chapter = source?.chapters.find(c => c.id === chapterId);
                if (!chapter) return;
                const cleanedSource = source.chapters.filter(c => c.id !== chapterId);
                setBooks(books.map(b => {
                    if (b.id === sourceBookId) return { ...b, chapters: cleanedSource };
                    if (b.id === targetBookId) return { ...b, chapters: [...b.chapters, chapter] };
                    return b;
                }));
            };

            const resetMoveModes = () => {
                booksMoveMode.exitMoveMode();
                rootNotesMoveMode.exitMoveMode();
                bookNotesMoveMode.exitMoveMode();
                chaptersMoveMode.exitMoveMode();
                setBookSelectionMode(false);
                setSelectedBookIds([]);
                setActiveSelectedBookId(null);
                setChapterSelectionMode(false);
                setSelectedChapterIds([]);
                setActiveSelectedChapterId(null);
            };

            const goHome = () => { resetMoveModes(); setView('home'); setActiveBookId(null); setActiveChapterId(null); };
            const goBook = (id) => { resetMoveModes(); setActiveBookId(id); setView('book'); };
            const goChapter = (id) => { resetMoveModes(); setActiveChapterId(id); setView('chapter'); };
            const goSettings = () => setView('settings');

            const startBookEdit = (book) => setEditingBook({ id: book.id, title: book.title });
            const saveBookEdit = () => {
                if (!editingBook.title.trim()) return;
                renameBook(editingBook.id, editingBook.title.trim());
                setEditingBook({ id: null, title: "" });
            };
            const cancelBookEdit = () => setEditingBook({ id: null, title: "" });

            const startChapterEdit = (chapter) => setEditingChapter({ id: chapter.id, title: chapter.title });
            const saveChapterEdit = () => {
                if (!editingChapter.title.trim()) return;
                renameChapter(activeBookId, editingChapter.id, editingChapter.title.trim());
                setEditingChapter({ id: null, title: "" });
            };
            const cancelChapterEdit = () => setEditingChapter({ id: null, title: "" });

            const startDictation = (target) => {
                if (micSupportError) return alert(micSupportError);
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.onstart = () => setIsRecording(true);
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript?.trim();
                    if (!transcript) return;
                    if (target.type === 'root') addRootNote(transcript);
                    if (target.type === 'book') addBookNote(target.bookId, transcript);
                };
                recognition.onerror = (event) => {
                    console.error(event);
                    setIsRecording(false);
                    setRecordingTarget(null);
                    if (event.error === 'not-allowed') alert("Permiso de micrófono denegado.");
                };
                recognition.onend = () => {
                    setIsRecording(false);
                    setRecordingTarget(null);
                };
                setRecordingTarget(target);
                recognition.start();
                recognitionRef.current = recognition;
            };

            const toggleDictation = (target) => {
                if (isRecording && recordingTarget?.type === target.type && recordingTarget?.bookId === target.bookId) {
                    recognitionRef.current?.stop();
                } else {
                    if (isRecording) recognitionRef.current?.stop();
                    startDictation(target);
                }
            };

            const openNoteModal = (target) => {
                setNoteDraft(target?.initialContent || '<p></p>');
                setNoteModal({ open: true, target });
            };
            const closeNoteModal = () => { setNoteDraft('<p></p>'); setNoteModal({ open: false, target: null }); };
            const handleSaveTypedNote = () => {
                const content = normalizeContent(noteDraft);
                const target = noteModal.target;
                if (!target?.onSave) return;
                target.onSave(content);
                closeNoteModal();
            };

            const closePicker = () => setPicker({ open: false, options: [], title: '', resolve: null });
            const openPickerWithOptions = (options, title = 'Selecciona destino') => new Promise((resolve) => {
                setPicker({ open: true, options, title, resolve });
            });
            const handlePickOption = (option) => {
                if (picker.resolve) picker.resolve(option);
                closePicker();
            };

            // Componente de Pantalla de Carga
            if (loading) {
                return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
                        <div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
                            <div className="loader mb-4"></div>
                            <p className="text-gray-700 font-medium">Procesando con IA...</p>
                        </div>
                    </div>
                );
            }

            // Header
            const Header = ({ title, onBack, accentClass = 'text-slate-900' }) => (
                <header
                    className="glass-panel safe-top sticky top-0 z-20 px-4 py-3 flex items-center justify-between border-b border-slate-200 shadow-sm"
                >
                    <div className="flex items-center gap-2 overflow-hidden">
                        {onBack && (
                            <button
                                onClick={onBack}
                                className="icon-btn text-slate-600 hover:text-slate-900"
                            >
                                <Icons.ChevronLeft />
                            </button>
                        )}
                        <div className="flex flex-col min-w-0">
                            <h1 className={`text-base font-semibold truncate ${accentClass}`}>
                                {title}
                            </h1>
                        </div>
                    </div>

                    <button
                        onClick={goSettings}
                        className="icon-btn text-slate-500 hover:text-blue-600"
                    >
                        <Icons.Settings />
                    </button>
                </header>
            );

            // --- VISTA: SETTINGS (Mejorada) ---
            if (view === 'settings') {
                const testConnection = async () => {
                    setTestStatus('loading');
                    try {
                        await callGemini(settings.apiKey, settings.model, "Di hola", "Test de conexión");
                        setTestStatus('success');
                        setTestMsg("¡Conexión Exitosa!");
                    } catch (e) {
                        setTestStatus('error');
                        setTestMsg(e.message);
                    }
                };

                return (
                    <div className="min-h-screen bg-gray-50">
                        <Header title="Configuración" onBack={() => view === 'home' ? null : window.history.back() || goHome()} />
                        <div className="p-4 max-w-md mx-auto space-y-6">
                            
                            {/* Sección API */}
                            <div className="bg-white p-4 rounded-lg shadow space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                                    <input type="text" value={settings.apiKey} onChange={(e) => setSettings({...settings, apiKey: e.target.value})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm font-mono focus:ring-2 focus:ring-blue-500 outline-none" placeholder="AIzaSy..." />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Modelo (Model Name)</label>
                                    <div className="flex gap-2">
                                        <select 
                                            value={settings.model} 
                                            onChange={(e) => setSettings({...settings, model: e.target.value})}
                                            className="w-full p-2 border rounded-md bg-gray-50 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                        >
                                            <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Predeterminado)</option>
                                            <option value="gemini-1.5-flash">gemini-1.5-flash (Estándar)</option>
                                            <option value="gemini-1.5-pro">gemini-1.5-pro (Más inteligente)</option>
                                            <option value="gemini-pro">gemini-pro (Legacy)</option>
                                        </select>
                                    </div>
                                    {/* Opción manual por si acaso */}
                                    <input 
                                        type="text" 
                                        value={settings.model}
                                        onChange={(e) => setSettings({...settings, model: e.target.value})}
                                        placeholder="Nombre manual del modelo..."
                                        className="w-full mt-2 p-2 border border-dashed rounded-md text-xs text-gray-500"
                                    />
                                </div>

                                <button onClick={testConnection} disabled={testStatus === 'loading'}
                                    className={`w-full py-2 px-4 rounded text-sm font-medium border transition flex items-center justify-center gap-2
                                    ${testStatus === 'success' ? 'bg-green-50 text-green-700 border-green-200' : 
                                      testStatus === 'error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {testStatus === 'loading' ? <div className="loader w-4 h-4 border-2 border-gray-400 border-t-transparent"></div> : 
                                     testStatus === 'success' ? <Icons.Check /> : 
                                     testStatus === 'error' ? <Icons.Alert /> : "Probar Conexión"}
                                    {testStatus === 'loading' ? ' Probando...' : testStatus === 'success' ? ' Conectado' : testStatus === 'error' ? ' Error' : ' Probar Conexión'}
                                </button>
                                {testMsg && <p className={`text-xs ${testStatus === 'error' ? 'text-red-600' : 'text-green-600'}`}>{testMsg}</p>}
                            </div>

                            {/* Sección Prompts */}
                            <div className="bg-white p-4 rounded-lg shadow">
                                <h3 className="font-medium text-gray-800 mb-3 border-b pb-2">Prompts</h3>
                                <div className="mb-4">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Fusión</label>
                                    <textarea value={settings.prompts.merge} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, merge: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Estilo</label>
                                    <textarea value={settings.prompts.style} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, style: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                                <div className="mt-4">
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Generación de notas</label>
                                    <textarea value={settings.prompts.generate} onChange={(e) => setSettings({...settings, prompts: {...settings.prompts, generate: e.target.value}})}
                                        className="w-full p-2 border rounded-md bg-gray-50 text-sm h-20 resize-none" />
                                </div>
                            </div>

                            <button onClick={() => { if(activeChapterId) goChapter(activeChapterId); else if(activeBookId) goBook(activeBookId); else goHome(); }}
                                className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition shadow-lg">
                                Guardar y Salir
                            </button>
                        </div>
                    </div>
                );
            }

            const activeBook = books.find(b => b.id === activeBookId);
            const activeChapter = activeBook?.chapters.find(c => c.id === activeChapterId);
            const pickerPortal = <OptionPicker state={picker} onSelect={handlePickOption} onClose={() => handlePickOption(null)} />;

            const pushAsLast = (list, id) => {
                const filtered = list.filter(item => item !== id);
                return [...filtered, id];
            };

            const booksMoveMode = useLongPressMoveMode(500, {
                onEnterMoveMode: (id) => {
                    setBookSelectionMode(true);
                    setSelectedBookIds((prev) => {
                        const updated = pushAsLast(prev, id);
                        setActiveSelectedBookId(id);
                        return updated;
                    });
                }
            });
            const rootNotesMoveMode = useLongPressMoveMode(500);
            const bookNotesMoveMode = useLongPressMoveMode(500);
            const chaptersMoveMode = useLongPressMoveMode(500, {
                onEnterMoveMode: (id) => {
                    setChapterSelectionMode(true);
                    setSelectedChapterIds((prev) => {
                        const updated = pushAsLast(prev, id);
                        setActiveSelectedChapterId(id);
                        return updated;
                    });
                }
            });

            const primaryBookId = selectedBookIds.includes(activeSelectedBookId)
                ? activeSelectedBookId
                : selectedBookIds[selectedBookIds.length - 1];
            const primaryChapterId = selectedChapterIds.includes(activeSelectedChapterId)
                ? activeSelectedChapterId
                : selectedChapterIds[selectedChapterIds.length - 1];

            const toggleBookSelection = (id) => {
                setBookSelectionMode(true);
                setSelectedBookIds(prev => {
                    const updated = prev.includes(id)
                        ? prev.filter(b => b !== id)
                        : [...prev, id];
                    const preferred = updated.includes(id) ? id : activeSelectedBookId;
                    const nextPrimary = preferred && updated.includes(preferred)
                        ? preferred
                        : (updated[updated.length - 1] || null);
                    setActiveSelectedBookId(nextPrimary);
                    return updated;
                });
                booksMoveMode.exitMoveMode();
            };

            const toggleChapterSelection = (id) => {
                setChapterSelectionMode(true);
                setSelectedChapterIds(prev => {
                    const updated = prev.includes(id)
                        ? prev.filter(c => c !== id)
                        : [...prev, id];
                    const preferred = updated.includes(id) ? id : activeSelectedChapterId;
                    const nextPrimary = preferred && updated.includes(preferred)
                        ? preferred
                        : (updated[updated.length - 1] || null);
                    setActiveSelectedChapterId(nextPrimary);
                    return updated;
                });
                chaptersMoveMode.exitMoveMode();
            };

            const cancelBookSelection = () => {
                setBookSelectionMode(false);
                setSelectedBookIds([]);
                setActiveSelectedBookId(null);
                booksMoveMode.exitMoveMode();
            };

            const cancelChapterSelection = () => {
                setChapterSelectionMode(false);
                setSelectedChapterIds([]);
                setActiveSelectedChapterId(null);
                chaptersMoveMode.exitMoveMode();
            };

            const handleBookBulkDelete = () => {
                if (selectedBookIds.length === 0) return;
                if (!confirm('¿Eliminar libros seleccionados?')) return;
                setBooks(prev => prev.filter(b => !selectedBookIds.includes(b.id)));
                cancelBookSelection();
            };

            const handleChapterBulkDelete = () => {
                if (selectedChapterIds.length === 0) return;
                if (!confirm('¿Eliminar capítulos seleccionados?')) return;
                setBooks(prev => prev.map(b => b.id === activeBookId ? { ...b, chapters: b.chapters.filter(c => !selectedChapterIds.includes(c.id)) } : b));
                cancelChapterSelection();
            };

            const handleBookReorder = (direction) => {
                if (!primaryBookId) return;
                reorderBook(primaryBookId, direction);
            };

            const handleChapterReorder = (direction) => {
                if (!primaryChapterId) return;
                reorderChapter(activeBookId, primaryChapterId, direction);
            };

            const handleBookMoveToPosition = () => {
                if (!primaryBookId) return;
                moveBookToPosition(primaryBookId);
            };

            const handleDuplicateBook = () => {
                if (!primaryBookId) return;
                duplicateBook(primaryBookId);
            };

            const handleRenameBook = () => {
                if (!primaryBookId) return;
                const book = books.find(b => b.id === primaryBookId);
                if (!book) return;
                startBookEdit(book);
                cancelBookSelection();
            };

            const handleRenameChapter = () => {
                if (!primaryChapterId) return;
                const chapter = activeBook?.chapters.find(c => c.id === primaryChapterId);
                if (!chapter) return;
                startChapterEdit(chapter);
                cancelChapterSelection();
            };

            const handleChapterMoveOrCopy = async (mode) => {
                if (!primaryChapterId) return;
                const available = books.filter(b => b.id !== activeBookId);
                if (available.length === 0) return alert('No hay otros libros disponibles.');
                const choice = await openPickerWithOptions(available.map(b => ({ label: b.title, bookId: b.id })), mode === 'move' ? 'Mover a libro' : 'Copiar en libro');
                if (!choice?.bookId) return;
                if (mode === 'move') {
                    moveChapterToBook(activeBookId, primaryChapterId, choice.bookId);
                    cancelChapterSelection();
                } else {
                    copyChapterToBook(activeBookId, primaryChapterId, choice.bookId);
                }
            };

            if (view === 'home') {
                return (
                    <>
                    <div className="min-h-screen flex flex-col bg-blue-50">
                        <Header title="Mis Libros" accentClass="text-blue-800" />

                        <main className="flex-1 px-4 pt-4 pb-24 max-w-md mx-auto w-full">
                            {bookSelectionMode && (
                                <div className="mb-4 p-3 bg-white rounded-xl shadow border border-blue-100 space-y-2">
                                    <div className="flex items-center justify-between gap-2 flex-wrap">
                                        <span className="text-sm font-semibold text-blue-800">{selectedBookIds.length} seleccionados</span>
                                        <button onClick={cancelBookSelection} className="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium">Cancelar</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        <button disabled={!primaryBookId} onClick={handleBookMoveToPosition} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryBookId ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Mover</button>
                                        <button disabled={!primaryBookId} onClick={handleRenameBook} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryBookId ? 'bg-blue-100 text-blue-800 border-blue-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Renombrar</button>
                                        <button disabled={!primaryBookId} onClick={handleDuplicateBook} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryBookId ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Copiar</button>
                                        <button disabled={selectedBookIds.length === 0} onClick={handleBookBulkDelete} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${selectedBookIds.length > 0 ? 'bg-red-50 text-red-700 border-red-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Eliminar</button>
                                    </div>
                                </div>
                            )}
                            {books.length === 0 && (
                                <div className="text-center py-10 text-gray-400">
                                    <p>No tienes libros creados.</p>
                                </div>
                            )}

                            <div className="space-y-3 mt-4">
                                {books.map((book) => {
                                    const moveProps = booksMoveMode.getItemProps(book.id);
                                    const isSelected = selectedBookIds.includes(book.id);
                                    const showMoveControls = bookSelectionMode && primaryBookId === book.id;
                                    return (
                                    <div
                                        key={book.id}
                                        {...moveProps}
                                        onClick={(e) => {
                                            moveProps.onClick?.(e);
                                            if (e.defaultPrevented) return;
                                            if (bookSelectionMode) {
                                                toggleBookSelection(book.id);
                                            } else {
                                                goBook(book.id);
                                            }
                                        }}
                                        className={`card card-tap p-4 flex items-center gap-3 ${isSelected ? 'ring-2 ring-blue-300 bg-blue-50' : ''}`}
                                    >
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (bookSelectionMode) {
                                                    toggleBookSelection(book.id);
                                                } else {
                                                    goBook(book.id);
                                                }
                                            }}
                                            className="flex-shrink-0 w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center"
                                        >
                                            <Icons.Book />
                                        </button>

                                        <div className="flex-1">
                                            {editingBook.id === book.id ? (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        value={editingBook.title}
                                                        onChange={(e) =>
                                                            setEditingBook({ ...editingBook, title: e.target.value })
                                                        }
                                                        className="w-full p-2 border rounded-md text-sm"
                                                        autoFocus
                                                    />
                                                    <button
                                                        onClick={saveBookEdit}
                                                        className="text-green-600 text-sm font-semibold"
                                                    >
                                                        Guardar
                                                    </button>
                                                    <button
                                                        onClick={cancelBookEdit}
                                                        className="text-gray-400 text-sm"
                                                    >
                                                        Cancelar
                                                    </button>
                                                </div>
                                            ) : (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        if (bookSelectionMode) {
                                                            toggleBookSelection(book.id);
                                                        } else {
                                                            goBook(book.id);
                                                        }
                                                    }}
                                                    className="w-full text-left"
                                                >
                                                    <h3 className="font-semibold text-slate-900 text-sm truncate">
                                                        {book.title}
                                                    </h3>
                                                    <p className="text-xs text-slate-500">
                                                        {book.chapters.length} capítulos
                                                    </p>
                                                </button>
                                            )}
                                        </div>

                                        <div className="flex-shrink-0 flex items-center">
                                            {showMoveControls ? (
                                                <MoveControls
                                                    onMoveUp={() => reorderBook(book.id, -1)}
                                                    onMoveDown={() => reorderBook(book.id, 1)}
                                                    accentClass="text-blue-800"
                                                />
                                            ) : (
                                                !bookSelectionMode && (
                                                    <ActionMenu
                                                        colorClass="bg-blue-700"
                                                        options={[
                                                            { label: 'Cambiar nombre', onClick: () => startBookEdit(book) },
                                                            { label: 'Mover', onClick: () => moveBookToPosition(book.id) },
                                                            { label: 'Subir', onClick: () => reorderBook(book.id, -1) },
                                                            { label: 'Bajar', onClick: () => reorderBook(book.id, 1) },
                                                            { label: 'Copiar libro', onClick: () => duplicateBook(book.id) },
                                                            { label: 'Eliminar', onClick: () => { if (confirm('¿Borrar libro y todo su contenido?')) deleteBook(book.id); } },
                                                        ]}
                                                    />
                                                )
                                            )}
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>

                            {rootNotes.length > 0 && (
                                <div className="space-y-2 mt-4">
                                    {rootNotes.map(note => {
                                        const moveProps = rootNotesMoveMode.getItemProps(note.id);
                                        return (
                                            <NoteChip
                                                key={note.id}
                                                note={note}
                                                moveHandlers={moveProps}
                                                moveModeActive={rootNotesMoveMode.moveModeId === note.id}
                                                actions={{
                                                    onEdit: () => openNoteModal({
                                                        title: 'Editar nota',
                                                        initialContent: note.content,
                                                        onSave: (html) => setRootNotes(rootNotes.map(n => n.id === note.id ? { ...n, content: html } : n))
                                                    }),
                                                    onDelete: () => setRootNotes(rootNotes.filter(n => n.id !== note.id)),
                                                    onMoveUp: () => reorderRootNote(note.id, -1),
                                                    onMoveDown: () => reorderRootNote(note.id, 1),
                                                    onMove: async () => { const dest = await chooseDestination({ type: 'root' }); if (dest) relocateNote({ type: 'root' }, dest, note.id, 'move'); },
                                                    onCopy: async () => { const dest = await chooseDestination({ type: 'root' }); if (dest) relocateNote({ type: 'root' }, dest, note.id, 'copy'); }
                                                }}
                                            />
                                        );
                                    })}
                                </div>
                            )}

                            <div className="mt-6">
                                <button
                                    onClick={() => {
                                        const title = prompt("Nuevo libro:");
                                        if (title) addBook(title);
                                    }}
                                    className="w-full flex items-center justify-center gap-2 bg-blue-700 text-white py-3 rounded-2xl font-medium shadow-lg hover:bg-blue-800 active:scale-[0.98] transition"
                                >
                                    <Icons.Plus />
                                    <span>Nuevo Libro</span>
                                </button>
                            </div>
                        </main>

                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center gap-2">
                            {isRecording && recordingTarget?.type === 'root' && <p className="bg-black/70 text-white text-xs px-2 py-1 rounded whitespace-nowrap animate-pulse">Escuchando...</p>}
                            <div className="flex items-center gap-3 bg-white/85 backdrop-blur rounded-full shadow-lg border px-3 py-2">
                                <button onClick={() => openNoteModal({ title: 'Nueva nota rápida', onSave: (html) => addRootNote(html) })} className="w-12 h-12 rounded-full bg-blue-200 text-blue-900 flex items-center justify-center text-lg shadow hover:bg-blue-300" title="Escribir nota">
                                    📝
                                </button>
                                <button
                                    onClick={() => toggleDictation({ type: 'root' })}
                                    disabled={!!micSupportError}
                                    className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 text-white ${isRecording && recordingTarget?.type === 'root' ? 'bg-red-500 pulse-ring scale-110' : 'bg-blue-700 hover:bg-blue-800 hover:scale-105'} ${micSupportError ? 'bg-gray-400 cursor-not-allowed hover:scale-100 hover:bg-gray-400' : ''}`}
                                >
                                    {isRecording && recordingTarget?.type === 'root' ? <div className="w-6 h-6 bg-white rounded-sm" /> : <Icons.Mic />}
                                </button>
                            </div>
                        </div>

                        <NoteEditorModal
                            isOpen={noteModal.open}
                            title={noteModal.target?.title || 'Nueva nota'}
                            value={noteDraft}
                            onChange={setNoteDraft}
                            onSave={handleSaveTypedNote}
                            onClose={closeNoteModal}
                        />

                    </div>
                    {pickerPortal}
                    </>
                );
            }
            if (view === 'book' && activeBook) {
                const handleStyleBook = async () => {
                    if(activeBook.chapters.length === 0) return alert("Libro vacío.");
                    const styleDesc = prompt("Describe el estilo para todo el libro:");
                    if (!styleDesc) return;
                    setLoading(true);
                    try {
                        let newChapters = JSON.parse(JSON.stringify(activeBook.chapters));
                        for (let chapter of newChapters) {
                            if (chapter.notes.length === 0) continue;
                            const chapterText = chapter.notes.map(n => n.content).join("\n");
                            const finalPrompt = settings.prompts.style.replace('{STYLE}', styleDesc);
                            const newText = await callGemini(settings.apiKey, settings.model, finalPrompt, chapterText);
                            chapter.notes = [{ id: generateId(), content: normalizeContent(newText), timestamp: Date.now() }];
                        }
                        updateBookChapters(activeBook.id, newChapters);
                        alert("¡Libro reescrito!");
                    } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
                };

                const handleGenerateBook = async () => {
                    if(activeBook.chapters.length === 0) return alert("Libro vacío.");
                    const promptText = prompt("¿Qué necesitas generar a partir del libro?");
                    if (!promptText) return;
                    setLoading(true);
                    try {
                        const bookContent = activeBook.chapters.map(ch => `Capítulo: ${ch.title}\n${ch.notes.map(n => n.content).join('\n')}`).join('\n\n');
                        const finalPrompt = `${settings.prompts.generate}\n\nPetición: ${promptText}`;
                        const newText = await callGemini(settings.apiKey, settings.model, finalPrompt, bookContent);
                        const newChapterId = generateId();
                        const newNoteId = generateId();
                        setBooks(books.map(b => b.id === activeBook.id ? {
                            ...b,
                            chapters: [...b.chapters, { id: newChapterId, title: `Generado ${new Date().toLocaleTimeString()}`, notes: [{ id: newNoteId, content: normalizeContent(newText), timestamp: Date.now() }] }]
                        } : b));
                        alert("Nueva nota generada y guardada en un capítulo nuevo.");
                    } catch (e) { alert("Error: " + e.message); } finally { setLoading(false); }
                };

                return (
                    <>
                    <div className="min-h-screen flex flex-col bg-violet-50">
                        <Header title={activeBook.title} onBack={goHome} accentClass="text-violet-800" />
                        <main className="flex-1 px-4 pt-4 pb-24 max-w-md mx-auto w-full space-y-4">
                            <div className="flex flex-wrap items-center justify-between gap-2">
                                <button onClick={handleGenerateBook} className="text-xs flex items-center gap-2 bg-violet-100 text-violet-800 px-4 py-2 rounded-full font-semibold border border-violet-200 shadow-sm">💡 Generar resumen</button>
                                <button onClick={handleStyleBook} className="text-xs flex items-center gap-2 bg-violet-200 text-violet-900 px-4 py-2 rounded-full font-semibold border border-violet-300 shadow-sm"><Icons.Wand className="w-3 h-3" /> Estilo del libro</button>
                            </div>

                            {chapterSelectionMode && (
                                <div className="p-3 bg-white rounded-xl shadow border border-violet-100 space-y-2">
                                    <div className="flex items-center justify-between gap-2 flex-wrap">
                                        <span className="text-sm font-semibold text-violet-800">{selectedChapterIds.length} seleccionados</span>
                                        <button onClick={cancelChapterSelection} className="text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium">Cancelar</button>
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        <button disabled={!primaryChapterId} onClick={() => handleChapterMoveOrCopy('move')} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryChapterId ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Mover de libro</button>
                                        <button disabled={!primaryChapterId} onClick={() => handleChapterMoveOrCopy('copy')} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryChapterId ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Copiar</button>
                                        <button disabled={!primaryChapterId} onClick={handleRenameChapter} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${primaryChapterId ? 'bg-violet-100 text-violet-900 border-violet-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Renombrar</button>
                                        <button disabled={selectedChapterIds.length === 0} onClick={handleChapterBulkDelete} className={`text-xs px-3 py-1.5 rounded-full border font-semibold ${selectedChapterIds.length > 0 ? 'bg-red-50 text-red-700 border-red-200' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-not-allowed'}`}>Eliminar</button>
                                    </div>
                                </div>
                            )}

                            {activeBook.chapters.length === 0 && <div className="text-center py-10 text-gray-400"><p>Libro vacío.</p></div>}
                            <div className="space-y-3">
                                {activeBook.chapters.map((chap) => {
                                    const moveProps = chaptersMoveMode.getItemProps(chap.id);
                                    const isSelected = selectedChapterIds.includes(chap.id);
                                    const showMoveControls = chapterSelectionMode && primaryChapterId === chap.id;
                                    return (
                                    <div
                                        key={chap.id}
                                        {...moveProps}
                                        onClick={(e) => {
                                            moveProps.onClick?.(e);
                                            if (e.defaultPrevented) return;
                                            if (chapterSelectionMode) {
                                                toggleChapterSelection(chap.id);
                                            } else {
                                                goChapter(chap.id);
                                            }
                                        }}
                                        className={`card card-tap p-4 flex items-center gap-3 ${isSelected ? 'ring-2 ring-violet-300 bg-violet-50' : ''}`}
                                    >
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (chapterSelectionMode) {
                                                    toggleChapterSelection(chap.id);
                                                } else {
                                                    goChapter(chap.id);
                                                }
                                            }}
                                            className="flex-shrink-0 w-10 h-10 rounded-xl bg-violet-100 text-violet-700 flex items-center justify-center"
                                        >
                                            <Icons.Folder />
                                        </button>

                                        <div className="flex-1">
                                            {editingChapter.id === chap.id ? (
                                                <div className="flex items-center gap-2">
                                                    <input
                                                        value={editingChapter.title}
                                                        onChange={(e) =>
                                                            setEditingChapter({ ...editingChapter, title: e.target.value })
                                                        }
                                                        className="w-full p-2 border rounded-md text-sm"
                                                        autoFocus
                                                    />
                                                    <button
                                                        onClick={saveChapterEdit}
                                                        className="text-green-600 text-sm font-semibold"
                                                    >
                                                        Guardar
                                                    </button>
                                                    <button
                                                        onClick={cancelChapterEdit}
                                                        className="text-gray-400 text-sm"
                                                    >
                                                        Cancelar
                                                    </button>
                                                </div>
                                            ) : (
                                                <button
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        if (chapterSelectionMode) {
                                                            toggleChapterSelection(chap.id);
                                                        } else {
                                                            goChapter(chap.id);
                                                        }
                                                    }}
                                                    className="w-full text-left"
                                                >
                                                    <h3 className="font-semibold text-slate-900 text-sm truncate">
                                                        {chap.title}
                                                    </h3>
                                                    <p className="text-xs text-slate-500">
                                                        {chap.notes.length} notas
                                                    </p>
                                                </button>
                                            )}
                                        </div>

                                        <div className="flex-shrink-0 flex items-center">
                                            {showMoveControls ? (
                                                <MoveControls
                                                    onMoveUp={() => reorderChapter(activeBook.id, chap.id, -1)}
                                                    onMoveDown={() => reorderChapter(activeBook.id, chap.id, 1)}
                                                    accentClass="text-violet-800"
                                                />
                                            ) : (
                                                !chapterSelectionMode && (
                                                    <ActionMenu
                                                        colorClass="bg-violet-700"
                                                        options={[
                                                            { label: 'Cambiar nombre', onClick: () => startChapterEdit(chap) },
                                                            { label: 'Mover', onClick: async () => {
                                                                const available = books.filter(b => b.id !== activeBook.id);
                                                                if (available.length === 0) return alert('No hay otros libros disponibles.');
                                                                const choice = await openPickerWithOptions(available.map(b => ({ label: b.title, bookId: b.id })), 'Mover a libro');
                                                                if (choice?.bookId) moveChapterToBook(activeBook.id, chap.id, choice.bookId);
                                                            } },
                                                            { label: 'Copiar', onClick: async () => {
                                                                const available = books.filter(b => b.id !== activeBook.id);
                                                                if (available.length === 0) return alert('No hay otros libros disponibles.');
                                                                const choice = await openPickerWithOptions(available.map(b => ({ label: b.title, bookId: b.id })), 'Copiar a libro');
                                                                if (choice?.bookId) copyChapterToBook(activeBook.id, chap.id, choice.bookId);
                                                            } },
                                                            { label: 'Subir', onClick: () => reorderChapter(activeBook.id, chap.id, -1)},
                                                            { label: 'Bajar', onClick: () => reorderChapter(activeBook.id, chap.id, 1) },
                                                            { label: 'Eliminar', onClick: () => { if (confirm('¿Borrar capítulo y sus notas?')) deleteChapter(activeBook.id, chap.id); } },
                                                        ]}
                                                    />
                                                )
                                            )}
                                        </div>
                                    </div>
                                    );
                                })}
                            </div>

                            {activeBook.notes?.length > 0 && (
                                <div className="space-y-2">
                                    {activeBook.notes.map(note => {
                                        const moveProps = bookNotesMoveMode.getItemProps(note.id);
                                        return (
                                            <NoteChip
                                                key={note.id}
                                                note={note}
                                                moveHandlers={moveProps}
                                                moveModeActive={bookNotesMoveMode.moveModeId === note.id}
                                                actions={{
                                                    onEdit: () => openNoteModal({
                                                        title: 'Editar nota',
                                                        initialContent: note.content,
                                                        onSave: (html) => updateBookNotes(activeBook.id, activeBook.notes.map(n => n.id === note.id ? { ...n, content: html } : n))
                                                    }),
                                                    onDelete: () => updateBookNotes(activeBook.id, activeBook.notes.filter(n => n.id !== note.id)),
                                                    onMoveUp: () => reorderBookNote(activeBook.id, note.id, -1),
                                                    onMoveDown: () => reorderBookNote(activeBook.id, note.id, 1),
                                                    onMove: async () => { const dest = await chooseDestination({ type: 'book', bookId: activeBook.id }); if (dest) relocateNote({ type: 'book', bookId: activeBook.id }, dest, note.id, 'move'); },
                                                    onCopy: async () => { const dest = await chooseDestination({ type: 'book', bookId: activeBook.id }); if (dest) relocateNote({ type: 'book', bookId: activeBook.id }, dest, note.id, 'copy'); }
                                                }}
                                            />
                                        );
                                    })}
                                </div>
                            )}

                            <div className="mt-6">
                                <button
                                    onClick={() => {
                                        const title = prompt("Nuevo capítulo:");
                                        if (title) addChapter(activeBook.id, title);
                                    }}
                                    className="w-full flex items-center justify-center gap-2 bg-violet-700 text-white py-3 rounded-2xl font-medium shadow-lg hover:bg-violet-800 active:scale-[0.98] transition"
                                >
                                    <Icons.Plus />
                                    <span>Nuevo Capítulo</span>
                                </button>
                            </div>
                        </main>

                        <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center gap-2">
                            {isRecording && recordingTarget?.bookId === activeBook.id && <p className="bg-black/70 text-white text-xs px-2 py-1 rounded whitespace-nowrap animate-pulse">Escuchando...</p>}
                            <div className="flex items-center gap-3 bg-white/85 backdrop-blur rounded-full shadow-lg border px-3 py-2">
                                <button onClick={() => openNoteModal({ title: 'Nueva nota del libro', onSave: (html) => addBookNote(activeBook.id, html) })} className="w-12 h-12 rounded-full bg-violet-200 text-violet-900 flex items-center justify-center text-lg shadow hover:bg-violet-300" title="Escribir nota del libro">
                                    📝
                                </button>
                                <button
                                    onClick={() => toggleDictation({ type: 'book', bookId: activeBook.id })}
                                    disabled={!!micSupportError}
                                    className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 text-white ${isRecording && recordingTarget?.bookId === activeBook.id ? 'bg-red-500 pulse-ring scale-110' : 'bg-violet-700 hover:bg-violet-800 hover:scale-105'} ${micSupportError ? 'bg-gray-400 cursor-not-allowed hover:scale-100 hover:bg-gray-400' : ''}`}
                                >
                                    {isRecording && recordingTarget?.bookId === activeBook.id ? <div className="w-6 h-6 bg-white rounded-sm" /> : <Icons.Mic />}
                                </button>
                            </div>
                        </div>

                        <NoteEditorModal
                            isOpen={noteModal.open}
                            title={noteModal.target?.title || 'Nota'}
                            value={noteDraft}
                            onChange={setNoteDraft}
                            onSave={handleSaveTypedNote}
                            onClose={closeNoteModal}
                        />

                    </div>
                    {pickerPortal}
                    </>
                );
            }

            if (view === 'chapter' && activeChapter) {
                return (
                    <>
                    <NoteManager bookId={activeBookId} chapter={activeChapter} onBack={() => goBook(activeBookId)}
                        onAddNote={(text) => addNote(activeBookId, activeChapter.id, text)}
                        onUpdateNotes={(newNotes) => updateNotes(activeBookId, activeChapter.id, newNotes)}
                        editNote={editNote}
                        settings={settings} setLoading={setLoading}
                        chooseDestination={chooseDestination}
                        relocateNote={relocateNote} />
                    {pickerPortal}
                    </>
                );
            }
            return null;
        }

        // --- NOTE MANAGER (Optimized) ---
        function NoteManager({ bookId, chapter, onBack, onAddNote, onUpdateNotes, editNote, settings, setLoading, chooseDestination, relocateNote }) {
            const [isRecording, setIsRecording] = useState(false);
            const [selectedIds, setSelectedIds] = useState([]);
            const [selectionMode, setSelectionMode] = useState(false);
            const [noteDraft, setNoteDraft] = useState('<p></p>');
            const [noteModalOpen, setNoteModalOpen] = useState(false);
            const [editingNoteId, setEditingNoteId] = useState(null);
            const recognitionRef = useRef(null);
            const [supportError, setSupportError] = useState(null);

            const reorderNotesByIndex = useCallback((from, to) => {
                onUpdateNotes(moveItem(chapter.notes, from, to));
            }, [chapter.notes, onUpdateNotes]);
            const noteMoveMode = useLongPressMoveMode(500, {
                onEnterMoveMode: (id) => {
                    setSelectionMode(true);
                    setSelectedIds((prev) => prev.includes(id) ? prev : [...prev, id]);
                }
            });

            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) setSupportError("Navegador sin soporte de voz");
                return () => { if (recognitionRef.current) recognitionRef.current.stop(); }
            }, []);

            const startRecording = () => {
                if (supportError) return alert(supportError);
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false;
                recognition.onstart = () => setIsRecording(true);
                recognition.onresult = (event) => { if(event.results[0][0].transcript) onAddNote(event.results[0][0].transcript); };
                recognition.onerror = (event) => { console.error(event); setIsRecording(false); if(event.error === 'not-allowed') alert("Permiso de micrófono denegado."); };
                recognition.onend = () => setIsRecording(false);
                recognition.start();
                recognitionRef.current = recognition;
            };

            const toggleRecording = () => isRecording ? recognitionRef.current?.stop() : startRecording();
            const toggleSelect = (id) => setSelectedIds(prev => prev.includes(id) ? prev.filter(sid => sid !== id) : [...prev, id]);
            const handleSelectClick = (id) => {
                toggleSelect(id);
                noteMoveMode.activateMoveMode(id);
            };

            const openNoteModal = (note = null) => { setNoteDraft(note?.content || '<p></p>'); setEditingNoteId(note?.id || null); setNoteModalOpen(true); };
            const closeNoteModal = () => { setNoteDraft('<p></p>'); setEditingNoteId(null); setNoteModalOpen(false); };
            const saveTypedNote = () => {
                if (!noteDraft.trim()) return;
                if (editingNoteId) {
                    editNote(bookId, chapter.id, editingNoteId, noteDraft);
                } else {
                    onAddNote(noteDraft);
                }
                closeNoteModal();
            };

            const reorderNote = (id, direction) => {
                const index = chapter.notes.findIndex(n => n.id === id);
                const target = index + direction;
                if (target < 0 || target >= chapter.notes.length) return;
                onUpdateNotes(moveItem(chapter.notes, index, target));
            };

            const processAI = async (type, scope) => {
                const notes = scope === 'selection' ? chapter.notes.filter(n => selectedIds.includes(n.id)) : chapter.notes;
                if (notes.length === 0) return alert("Sin notas seleccionadas.");
                if (type === 'merge' && notes.length < 2) return alert("Selecciona 2+ notas.");

                const extraPrompt = type === 'style' ? prompt("Describe el estilo:") : type === 'generate' ? prompt("¿Qué necesitas generar?") : null;
                if ((type === 'style' || type === 'generate') && !extraPrompt) return;

                setLoading(true);
                try {
                    const text = notes.map(n => type === 'merge' ? `- ${n.content}` : n.content).join("\n\n");
                    let promptText = settings.prompts.merge;
                    if (type === 'style') promptText = settings.prompts.style.replace('{STYLE}', extraPrompt);
                    if (type === 'generate') promptText = `${settings.prompts.generate}\n\nPetición: ${extraPrompt}`;
                    const result = await callGemini(settings.apiKey, settings.model, promptText, text);

                    const newNote = { id: generateId(), content: normalizeContent(result), timestamp: Date.now() };
                    if (scope === 'selection') {
                        const remaining = chapter.notes.filter(n => !selectedIds.includes(n.id));
                        onUpdateNotes([...remaining, newNote]);
                        setSelectedIds([]); setSelectionMode(false);
                    } else {
                        onUpdateNotes([newNote]);
                    }
                } catch (e) { alert(e.message); } finally { setLoading(false); }
            };

            const deleteSelectedNotes = () => {
                if (selectedIds.length === 0) return;
                if (!confirm("¿Eliminar notas seleccionadas?")) return;
                onUpdateNotes(chapter.notes.filter(n => !selectedIds.includes(n.id)));
                setSelectedIds([]);
                setSelectionMode(false);
                noteMoveMode.exitMoveMode();
            };

            const bulkRelocate = async (mode) => {
                if (selectedIds.length === 0) return alert("Sin notas seleccionadas.");
                const destination = await chooseDestination({ type: 'chapter', bookId, chapterId: chapter.id });
                if (!destination) return;

                const isSameDestination = destination.type === 'chapter' && destination.bookId === bookId && destination.chapterId === chapter.id;
                if (isSameDestination) return alert('Elige un destino diferente.');

                selectedIds.forEach(id => relocateNote({ type: 'chapter', bookId, chapterId: chapter.id }, destination, id, mode));
                setSelectedIds([]);
                setSelectionMode(false);
                noteMoveMode.exitMoveMode();
            };

            return (
                <div className="min-h-screen flex flex-col bg-emerald-50">
                    <header className="glass-panel sticky top-0 z-10 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                        <div className="flex items-center gap-2">
                            <button onClick={onBack} className="p-1 rounded-full hover:bg-gray-100 text-gray-600"><Icons.ChevronLeft /></button>
                            <div className="overflow-hidden"><h1 className="text-lg font-bold text-emerald-800 truncate">{chapter.title}</h1><p className="text-xs text-gray-500 truncate">{selectedIds.length} seleccionadas</p></div>
                        </div>
                        <button onClick={() => { setSelectionMode(!selectionMode); setSelectedIds([]); noteMoveMode.exitMoveMode(); }} className={`text-xs px-3 py-1.5 rounded-full font-medium transition ${selectionMode ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'}`}>{selectionMode ? 'Cancelar' : 'Seleccionar'}</button>
                    </header>

                    <main className="flex-1 p-4 pb-32 w-full max-w-md mx-auto">
                        <div className="mb-4 flex flex-col gap-2">
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                {selectionMode && selectedIds.length > 1 && <button onClick={() => processAI('merge', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-emerald-100 text-emerald-800 px-3 py-2 rounded-lg border border-emerald-200 font-medium active:scale-95 transition" title="Fusiona y reemplaza la selección por una sola nota"><Icons.Merge className="w-3 h-3" /> Fusionar</button>}
                                {selectionMode && selectedIds.length > 0 && <button onClick={() => processAI('style', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg border border-emerald-200 font-medium active:scale-95 transition"><Icons.Wand className="w-3 h-3" /> Estilo (Sel)</button>}
                                {selectionMode && selectedIds.length > 0 && <button onClick={() => processAI('generate', 'selection')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-emerald-200 text-emerald-900 px-3 py-2 rounded-lg border border-emerald-300 font-medium active:scale-95 transition">💡 Generar</button>}
                                {!selectionMode && chapter.notes.length > 0 && <>
                                    <button onClick={() => processAI('style', 'chapter')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-emerald-50 text-emerald-700 px-3 py-2 rounded-lg border border-emerald-200 font-medium active:scale-95 transition"><Icons.Wand className="w-3 h-3" /> Estilo (Todo)</button>
                                    <button onClick={() => processAI('generate', 'chapter')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-emerald-200 text-emerald-900 px-3 py-2 rounded-lg border border-emerald-300 font-medium active:scale-95 transition">💡 Generar capítulo</button>
                                </>}
                            </div>
                            {selectionMode && selectedIds.length > 0 && (
                                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                    <button onClick={deleteSelectedNotes} className="whitespace-nowrap text-xs flex items-center gap-1 bg-red-50 text-red-700 px-3 py-2 rounded-lg border border-red-200 font-medium active:scale-95 transition"><Icons.Trash className="w-3 h-3" /> Eliminar</button>
                                    <button onClick={() => bulkRelocate('move')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-blue-50 text-blue-700 px-3 py-2 rounded-lg border border-blue-200 font-medium active:scale-95 transition"><Icons.Folder className="w-3 h-3" /> Mover</button>
                                    <button onClick={() => bulkRelocate('copy')} className="whitespace-nowrap text-xs flex items-center gap-1 bg-purple-50 text-purple-700 px-3 py-2 rounded-lg border border-purple-200 font-medium active:scale-95 transition"><Icons.Plus className="w-3 h-3" /> Duplicar</button>
                                </div>
                            )}
                        </div>

                        {chapter.notes.length === 0 && <div className="flex flex-col items-center justify-center h-64 text-gray-400"><Icons.Mic className="w-12 h-12 mb-2 opacity-20" /><p>Graba una nota</p></div>}

                        <div className="space-y-3">
                            {chapter.notes.map(note => {
                                const moveProps = noteMoveMode.getItemProps(note.id);
                                const baseActions = {
                                    onMoveUp: () => reorderNote(note.id, -1),
                                    onMoveDown: () => reorderNote(note.id, 1),
                                };
                                return (
                                    <NoteChip
                                        key={note.id}
                                        note={note}
                                        moveHandlers={moveProps}
                                        moveModeActive={noteMoveMode.moveModeId === note.id}
                                        selectionMode={selectionMode}
                                        isSelected={selectedIds.includes(note.id)}
                                        onCardClick={selectionMode ? () => handleSelectClick(note.id) : undefined}
                                        actions={selectionMode ? baseActions : {
                                            ...baseActions,
                                            onEdit: () => openNoteModal(note),
                                            onMove: async () => { const dest = await chooseDestination({ type: 'chapter', bookId, chapterId: chapter.id }); if(dest) relocateNote({ type: 'chapter', bookId, chapterId: chapter.id }, dest, note.id, 'move'); },
                                            onCopy: async () => { const dest = await chooseDestination({ type: 'chapter', bookId, chapterId: chapter.id }); if(dest) relocateNote({ type: 'chapter', bookId, chapterId: chapter.id }, dest, note.id, 'copy'); },
                                            onDelete: () => { if(confirm("¿Borrar?")) onUpdateNotes(chapter.notes.filter(n => n.id !== note.id)); }
                                        }}
                                    />
                                );
                            })}
                        </div>
                    </main>

                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center gap-2">
                        {isRecording && <p className="bg-black/70 text-white text-xs px-2 py-1 rounded whitespace-nowrap animate-pulse">Escuchando...</p>}
                        <div className="flex items-center gap-3 bg-white/85 backdrop-blur rounded-full shadow-lg border px-3 py-2">
                            <button onClick={openNoteModal} className="w-12 h-12 rounded-full bg-emerald-200 text-emerald-900 flex items-center justify-center text-lg shadow hover:bg-emerald-300" title="Escribir nota">
                                📝
                            </button>
                            <button onClick={toggleRecording} disabled={!!supportError} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-2xl transition-all duration-300 text-white ${isRecording ? 'bg-red-500 pulse-ring scale-110' : 'bg-emerald-700 hover:bg-emerald-800 hover:scale-105'} ${supportError ? 'bg-gray-400 cursor-not-allowed' : ''}`}>
                                {isRecording ? <div className="w-6 h-6 bg-white rounded-sm" /> : <Icons.Mic className="text-white" />}
                            </button>
                        </div>
                    </div>

                    <NoteEditorModal
                        isOpen={noteModalOpen}
                        title={editingNoteId ? 'Editar nota' : 'Añadir nota escrita'}
                        value={noteDraft}
                        onChange={setNoteDraft}
                        onSave={saveTypedNote}
                        onClose={closeNoteModal}
                    />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
