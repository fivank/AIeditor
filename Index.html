<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Libros, Cap√≠tulos y Notas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- React + ReactDOM desde CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel 7 para compilar JSX/ESNext en el navegador -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --bg: #050816;
      --bg-elevated: #0b1020;
      --accent: #6366f1;
      --accent-soft: rgba(99, 102, 241, 0.15);
      --accent-strong: rgba(99, 102, 241, 0.9);
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #f97373;
      --success: #22c55e;
      --radius-lg: 1.25rem;
      --radius-md: 0.9rem;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.75);
      --shadow-chip: 0 10px 25px rgba(15, 23, 42, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 12px;
    }

    #root {
      width: 100%;
      max-width: 780px;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      background: linear-gradient(140deg, rgba(15,23,42,0.98), rgba(15,23,42,0.9), rgba(17,24,39,0.94));
      border-radius: 1.7rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .blobs {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      opacity: 0.7;
    }

    .blob {
      position: absolute;
      border-radius: 999px;
      filter: blur(30px);
      transform: translate3d(0,0,0);
    }

    .blob-1 {
      width: 260px; height: 260px;
      top: -60px; left: -40px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.42), transparent 70%);
      opacity: 0.7;
    }

    .blob-2 {
      width: 280px; height: 280px;
      top: -90px; right: -80px;
      background: radial-gradient(circle, rgba(236, 72, 153, 0.32), transparent 70%);
      opacity: 0.7;
    }

    .blob-3 {
      width: 260px; height: 260px;
      bottom: -110px; left: 10%;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.33), transparent 70%);
      opacity: 0.6;
    }

    .blob-4 {
      width: 250px; height: 250px;
      bottom: -140px; right: -30px;
      background: radial-gradient(circle, rgba(52, 211, 153, 0.32), transparent 70%);
      opacity: 0.5;
    }

    .app-inner {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      max-height: 100vh;
    }

    header.app-header {
      padding: 12px 14px 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.9));
      position: sticky;
      top: 0;
      z-index: 3;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .back-btn {
      border: none;
      outline: none;
      background: rgba(15,23,42,0.7);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-soft);
      font-size: 18px;
      cursor: pointer;
      border: 1px solid rgba(148, 163, 184, 0.30);
      box-shadow: 0 10px 25px rgba(15,23,42,0.9);
      transition: all 0.16s ease;
    }

    .back-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15,23,42,0.95);
      border-color: rgba(129, 140, 248, 0.65);
      color: var(--accent);
    }

    .app-title-wrapper {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    h1.app-title {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(129, 140, 248, 0.55);
      background: radial-gradient(circle at top left, rgba(129,140,248,0.38), rgba(15,23,42,0.9));
      color: #e5e7eb;
    }

    .title-accent {
      background: linear-gradient(135deg, #a5b4fc, #38bdf8);
      -webkit-background-clip: text;
      color: transparent;
    }

    .app-subtitle {
      margin: 0;
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .app-subtitle span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .subtitle-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle, #22c55e 0, rgba(34,197,94,0.2) 60%);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill-indicator {
      font-size: 10px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.36);
      color: var(--text-soft);
      display: none;
    }

    @media (min-width: 450px) {
      .pill-indicator {
        display: inline-flex;
      }
    }

    .settings-btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 7px 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, rgba(15,23,42,0.95), rgba(30,64,175,0.9));
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      box-shadow: var(--shadow-chip);
      border: 1px solid rgba(129, 140, 248, 0.65);
      transition: all 0.16s ease;
    }

    .settings-btn span.icon {
      font-size: 16px;
    }

    .settings-btn span.label {
      display: none;
    }

    @media (min-width: 420px) {
      .settings-btn span.label {
        display: inline;
      }
    }

    .settings-btn.active {
      background: linear-gradient(135deg, rgba(15,23,42,1), rgba(17,24,39,0.96));
      border-color: rgba(248, 250, 252, 0.45);
    }

    .settings-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15,23,42,1);
    }

    main.app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px 12px 12px 12px;
      overflow: hidden;
    }

    .content-card {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 1.35rem;
      border: 1px solid rgba(31, 41, 55, 0.9);
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.95);
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
      position: relative;
    }

    @media (min-width: 640px) {
      .content-card {
        padding: 14px;
      }
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 10px;
    }

    .section-title-group {
      display: flex;
      flex-direction: column;
      gap: 1px;
      min-width: 0;
    }

    .section-title {
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .section-title span.emoji {
      font-size: 17px;
    }

    .section-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .section-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
    }

    .btn-primary,
    .btn-outline,
    .btn-ghost {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      border: 1px solid transparent;
      background: transparent;
      color: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: radial-gradient(circle at top left, var(--accent-strong), #1d4ed8);
      border-color: rgba(191, 219, 254, 0.9);
      color: #e5e7eb;
      box-shadow: var(--shadow-chip);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(15,23,42,0.95);
    }

    .btn-outline {
      border-color: rgba(148, 163, 184, 0.6);
      background: rgba(15,23,42,0.9);
      box-shadow: 0 10px 24px rgba(15,23,42,0.85);
      color: var(--text-soft);
    }

    .btn-outline:hover {
      border-color: rgba(129, 140, 248, 0.75);
      color: #e5e7eb;
      transform: translateY(-1px);
    }

    .btn-ghost {
      border-color: transparent;
      background: rgba(15, 23, 42, 0.7);
      color: var(--text-soft);
    }

    .btn-ghost:hover {
      background: rgba(31, 41, 55, 0.9);
      color: #e5e7eb;
    }

    .btn-icon-only {
      padding-inline: 8px;
      font-size: 16px;
      width: 32px;
      justify-content: center;
    }

    .btn-sm {
      padding: 5px 9px;
      font-size: 11px;
    }

    .list {
      border-radius: 1rem;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: linear-gradient(150deg, rgba(15,23,42,0.96), rgba(15,23,42,0.99));
      padding: 4px;
      margin-top: 6px;
      flex: 1;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.65) transparent;
    }

    .list::-webkit-scrollbar {
      width: 6px;
    }

    .list::-webkit-scrollbar-track {
      background: transparent;
    }

    .list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .list-empty {
      padding: 14px 10px 14px 10px;
      font-size: 12px;
      color: var(--text-soft);
      text-align: left;
    }

    .pill-helper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
      border-radius: var(--radius-pill);
      padding: 3px 8px 3px 5px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      margin-top: 4px;
    }

    .pill-helper-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.9), rgba(129, 140, 248, 0.2));
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: var(--text-soft);
      margin-top: 2px;
    }

    .chip span.dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(52, 211, 153, 0.9), rgba(52, 211, 153, 0.18));
    }

    .chip span.dot-red {
      background: radial-gradient(circle, rgba(248, 113, 113, 0.9), rgba(248, 113, 113, 0.18));
    }

    .list-item {
      border-radius: 0.9rem;
      padding: 9px 9px;
      margin: 3px 0;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .list-item:hover {
      border-color: rgba(129, 140, 248, 0.75);
      box-shadow: 0 10px 26px rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }

    .item-avatar {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(129,140,248,0.3), rgba(15,23,42,0.9));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 1px solid rgba(129, 140, 248, 0.6);
      box-shadow: 0 10px 26px rgba(15,23,42,1);
      flex-shrink: 0;
    }

    .item-content {
      flex: 1;
      min-width: 0;
    }

    .item-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 3px;
    }

    .item-badge {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-soft);
    }

    .item-subtitle {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-arrow {
      font-size: 14px;
      color: var(--text-soft);
      flex-shrink: 0;
    }

    .inline-form {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: nowrap;
    }

    .inline-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15, 23, 42, 0.95);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
      min-width: 0;
    }

    .inline-input::placeholder {
      color: rgba(148, 163, 184, 0.75);
    }

    .inline-input:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .notes-layout {
      display: flex;
      flex-direction: column;
      height: 100%;
      gap: 8px;
      overflow: hidden;
    }

    .notes-toolbar {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    @media (min-width: 640px) {
      .notes-toolbar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }

    .notes-left-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .notes-right-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .record-btn {
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      border: 1px solid transparent;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: radial-gradient(circle at top left, rgba(248,113,113,0.9), rgba(185,28,28,0.95));
      color: #fee2e2;
      box-shadow: 0 14px 32px rgba(127,29,29,0.95);
      transition: all 0.15s ease;
    }

    .record-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 38px rgba(127,29,29,1);
    }

    .record-btn.disabled,
    .btn-primary.disabled,
    .btn-outline.disabled,
    .btn-ghost.disabled {
      opacity: 0.55;
      pointer-events: none;
      cursor: default;
    }

    .record-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle, #f97373 0, rgba(248,113,113,0.2) 70%);
      box-shadow: 0 0 12px rgba(248,113,113,0.9);
    }

    .record-indicator.pulsing {
      animation: pulse 1.2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 12px rgba(248,113,113,0.9);
      }
      60% {
        transform: scale(1.4);
        box-shadow: 0 0 25px rgba(248,113,113,1);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 12px rgba(248,113,113,0.7);
      }
    }

    .notes-selection-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }

    .segmented-control {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.95);
      padding: 2px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.9);
    }

    .segmented-option {
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
    }

    .segmented-option.active {
      background: linear-gradient(135deg, rgba(129,140,248,0.95), rgba(56,189,248,0.95));
      color: #0b1120;
      border-color: rgba(191, 219, 254, 0.9);
    }

    .segmented-option span.dot-mini {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
    }

    .style-input {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15,23,42,0.95);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
      min-width: 0;
    }

    .style-input::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .style-input:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .notes-list {
      margin-top: 4px;
      flex: 1;
      overflow-y: auto;
      border-radius: 1rem;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: linear-gradient(150deg, rgba(15,23,42,0.97), rgba(15,23,42,0.99));
      padding: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(148, 163, 184, 0.65) transparent;
    }

    .notes-list::-webkit-scrollbar {
      width: 6px;
    }

    .notes-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }

    .note-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 7px 8px;
      border-radius: 0.9rem;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      margin: 3px 0;
      transition: all 0.15s ease;
    }

    .note-item.selected {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 10px 24px rgba(15,23,42,0.95);
    }

    .note-checkbox {
      margin-top: 2px;
      flex-shrink: 0;
      accent-color: var(--accent);
    }

    .note-body {
      flex: 1;
      min-width: 0;
    }

    .note-text {
      font-size: 13px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .note-meta {
      margin-top: 3px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 10px;
      color: var(--text-soft);
    }

    .note-time {
      opacity: 0.9;
    }

    .note-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .note-chip {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.95);
      font-size: 10px;
      color: var(--text-soft);
    }

    .manual-note-box {
      margin-top: 6px;
      border-radius: 1rem;
      border: 1px dashed rgba(55, 65, 81, 0.95);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .manual-note-textarea {
      width: 100%;
      min-height: 70px;
      max-height: 140px;
      border-radius: 0.8rem;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.98);
      color: var(--text-main);
      font-size: 12px;
      padding: 7px 8px;
      resize: vertical;
      outline: none;
    }

    .manual-note-textarea::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .manual-note-textarea:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .manual-note-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .helper-inline {
      font-size: 10px;
      color: var(--text-soft);
    }

    .settings-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 2px 2px 4px 2px;
      height: 100%;
      overflow-y: auto;
    }

    .settings-section {
      border-radius: 1rem;
      border: 1px solid rgba(31, 41, 55, 0.95);
      background: radial-gradient(circle at top left, rgba(15,23,42,0.98), rgba(15,23,42,0.99));
      padding: 10px;
    }

    .settings-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .settings-title span.icon {
      font-size: 16px;
    }

    .settings-description {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .field-label span.badge {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.65);
      padding: 1px 7px;
      font-size: 10px;
      background: rgba(15,23,42,0.95);
    }

    .settings-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.95);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
    }

    .settings-input::placeholder {
      color: rgba(148, 163, 184, 0.75);
    }

    .settings-input:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .settings-textarea {
      width: 100%;
      min-height: 94px;
      border-radius: 0.9rem;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.98);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      resize: vertical;
      outline: none;
    }

    .settings-textarea::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }

    .settings-textarea:focus {
      border-color: rgba(129, 140, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.6);
    }

    .settings-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 10px;
      color: var(--text-soft);
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .status-bar {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .status-pill {
      padding: 5px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.97);
      color: var(--text-soft);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.9), rgba(129, 140, 248, 0.25));
    }

    .status-pill.error {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    .status-pill.error span.dot {
      background: radial-gradient(circle, rgba(248, 113, 113, 0.95), rgba(248, 113, 113, 0.25));
    }

    .status-pill.success {
      border-color: rgba(52, 211, 153, 0.9);
      color: #bbf7d0;
    }

    .status-pill.success span.dot {
      background: radial-gradient(circle, rgba(52, 211, 153, 0.95), rgba(52, 211, 153, 0.25));
    }

    .status-pill.loading {
      opacity: 0.95;
    }

    .spinner {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.3);
      border-top-color: rgba(129, 140, 248, 0.95);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    footer.app-footer {
      padding: 6px 12px 10px 12px;
      font-size: 10px;
      color: var(--text-soft);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      border-top: 1px solid rgba(31, 41, 55, 0.95);
      background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(15,23,42,0.98));
    }

    .footer-pill {
      border-radius: 999px;
      padding: 3px 8px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.98);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .footer-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.9), rgba(129, 140, 248, 0.2));
    }

    .footer-right {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tag {
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: rgba(15,23,42,0.98);
    }

    @media (max-width: 480px) {
      .section-subtitle {
        display: none;
      }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
  const { useState, useEffect, useRef } = React;

  const STORAGE_KEYS = {
    DATA: 'voiceBooksData_v1',
    SETTINGS: 'voiceBooksSettings_v1',
  };

  // Incluyo tu API key como valor inicial por defecto (puedes cambiarla en Opciones)
  const defaultSettings = {
    apiKey: 'AIzaSyBHy7CI9Dr1oONZkqghOOguNGQts94BjvI',
    mergePrompt:
      'Eres una herramienta que fusiona notas casi literalmente. ' +
      'Une las notas dadas en un √∫nico texto coherente. ' +
      'Solo corrige lo estrictamente necesario: may√∫sculas iniciales, signos de puntuaci√≥n b√°sicos y espacios. ' +
      'No a√±adas ideas nuevas ni elimines detalles importantes. ' +
      'Devuelve √∫nicamente el texto final fusionado, sin comentarios ni explicaciones.',
    stylePrompt:
      'Eres una herramienta que reescribe un texto aplicando un estilo concreto indicado por el usuario. ' +
      'Debes mantener todo el contenido y el significado original. ' +
      'Solo corrige lo estrictamente necesario a nivel de may√∫sculas, signos de puntuaci√≥n y espacios. ' +
      'Aplica el estilo indicado sin introducir informaci√≥n nueva. ' +
      'Devuelve √∫nicamente el texto reescrito, sin comentarios ni explicaciones.',
  };

  function genId(prefix) {
    return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
  }

  function cleanTranscription(rawText) {
    if (!rawText) return '';
    let text = rawText.trim();
    text = text.replace(/\s+/g, ' ');
    if (!text) return '';
    text = text.charAt(0).toUpperCase() + text.slice(1);
    if (!/[.!?¬°¬ø‚Ä¶]$/.test(text)) {
      text += '.';
    }
    return text;
  }

  async function callGemini({ apiKey, systemPrompt, userPrompt }) {
    if (!apiKey) {
      throw new Error('Falta la API key de Gemini. Config√∫rala en Opciones.');
    }

    const endpoint =
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=' +
      encodeURIComponent(apiKey);

    const body = {
      contents: [
        {
          role: 'user',
          parts: [
            {
              text: (systemPrompt || '') + '\n\n' + (userPrompt || ''),
            },
          ],
        },
      ],
    };

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      let details = '';
      try {
        const errData = await res.json();
        if (errData && errData.error && errData.error.message) {
          details = ' - ' + errData.error.message;
        }
      } catch (e) {}
      throw new Error('Error ' + res.status + ' al llamar a Gemini' + details);
    }

    const data = await res.json();
    let text = '';

    if (data && Array.isArray(data.candidates) && data.candidates.length > 0) {
      const candidate = data.candidates[0];
      const content = candidate && candidate.content;
      const parts = content && content.parts;
      if (Array.isArray(parts)) {
        text = parts
          .map(function (p) {
            return (p && p.text) || '';
          })
          .join('');
      }
    }

    if (!text) {
      throw new Error('La respuesta de Gemini lleg√≥ vac√≠a.');
    }

    return text.trim();
  }

  function BookList({ books, onCreateBook, onOpenBook }) {
    const [newBook, setNewBook] = useState('');

    const handleCreate = () => {
      const name = newBook.trim();
      if (!name) return;
      onCreateBook(name);
      setNewBook('');
    };

    return (
      <div className="content-card">
        <div className="section-header">
          <div className="section-title-group">
            <div className="section-title">
              <span className="emoji">üìö</span>
              <span>Libros</span>
            </div>
            <div className="section-subtitle">
              Organiza tus ideas por libro &gt; cap√≠tulo &gt; nota.
            </div>
          </div>
          <div className="section-actions">
            <button className="btn-primary btn-sm" onClick={handleCreate}>
              <span>Ôºã</span>
              <span>Nuevo libro</span>
            </button>
          </div>
        </div>

        <div className="inline-form">
          <input
            className="inline-input"
            placeholder="Nombre del nuevo libro..."
            value={newBook}
            onChange={(e) => setNewBook(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                handleCreate();
              }
            }}
          />
          <button className="btn-outline btn-sm" onClick={handleCreate}>
            Crear
          </button>
        </div>

        <div className="list">
          {books.length === 0 ? (
            <div className="list-empty">
              No hay libros todav√≠a. Crea el primero para empezar.
              <div className="pill-helper">
                <span className="pill-helper-dot" />
                <span>Piensa en un libro como un proyecto o tema grande.</span>
              </div>
            </div>
          ) : (
            books.map((book, index) => {
              const firstChar =
                book && typeof book.title === 'string' && book.title.length > 0
                  ? book.title.charAt(0).toUpperCase()
                  : 'üìò';
              const chapterCount =
                book && Array.isArray(book.chapters) ? book.chapters.length : 0;
              return (
                <div
                  key={book.id}
                  className="list-item"
                  onClick={() => onOpenBook(book.id)}
                >
                  <div className="item-avatar">
                    <span>{firstChar}</span>
                  </div>
                  <div className="item-content">
                    <div className="item-title-row">
                      <div className="item-title">{book.title}</div>
                      <span className="item-arrow">‚Ä∫</span>
                    </div>
                    <div className="item-meta">
                      <span className="item-badge">
                        {chapterCount} cap√≠tulos
                      </span>
                      <span className="item-subtitle">
                        Libro #{index + 1}
                      </span>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    );
  }

  function ChapterList({ book, onCreateChapter, onOpenChapter }) {
    const [newChapter, setNewChapter] = useState('');

    const handleCreate = () => {
      const name = newChapter.trim();
      if (!name) return;
      onCreateChapter(name);
      setNewChapter('');
    };

    const chapterCount =
      book && Array.isArray(book.chapters) ? book.chapters.length : 0;

    return (
      <div className="content-card">
        <div className="section-header">
          <div className="section-title-group">
            <div className="section-title">
              <span className="emoji">üìñ</span>
              <span>{book.title}</span>
            </div>
            <div className="section-subtitle">
              {chapterCount} cap√≠tulo{chapterCount === 1 ? '' : 's'} en este libro.
            </div>
          </div>
          <div className="section-actions">
            <button className="btn-primary btn-sm" onClick={handleCreate}>
              <span>Ôºã</span>
              <span>Nuevo cap√≠tulo</span>
            </button>
          </div>
        </div>

        <div className="inline-form">
          <input
            className="inline-input"
            placeholder="Nombre del nuevo cap√≠tulo o secci√≥n..."
            value={newChapter}
            onChange={(e) => setNewChapter(e.target.value)}
            onKeyDown={(e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                handleCreate();
              }
            }}
          />
          <button className="btn-outline btn-sm" onClick={handleCreate}>
            Crear
          </button>
        </div>

        <div className="list">
          {chapterCount === 0 ? (
            <div className="list-empty">
              Este libro todav√≠a no tiene cap√≠tulos.
              <div className="pill-helper">
                <span className="pill-helper-dot" />
                <span>Usa cap√≠tulos para separar escenas, ideas o bloques de contenido.</span>
              </div>
            </div>
          ) : (
            book.chapters.map((chapter, index) => {
              const notesCount =
                chapter && Array.isArray(chapter.notes)
                  ? chapter.notes.length
                  : 0;
              return (
                <div
                  key={chapter.id}
                  className="list-item"
                  onClick={() => onOpenChapter(chapter.id)}
                >
                  <div className="item-avatar">
                    <span>‚úèÔ∏è</span>
                  </div>
                  <div className="item-content">
                    <div className="item-title-row">
                      <div className="item-title">{chapter.title}</div>
                      <span className="item-arrow">‚Ä∫</span>
                    </div>
                    <div className="item-meta">
                      <span className="item-badge">
                        {notesCount} notas
                      </span>
                      <span className="item-subtitle">
                        Cap√≠tulo #{index + 1}
                      </span>
                    </div>
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    );
  }

  function ChapterView({
    book,
    chapter,
    selectedNoteIds,
    setSelectedNoteIds,
    targetScope,
    setTargetScope,
    onAddNote,
    onManualNoteAdd,
    onMergeNotes,
    onStyleChange,
    aiLoading,
    aiError,
    infoMessage,
    supportsSpeech,
  }) {
    const [isRecording, setIsRecording] = useState(false);
    const [manualNote, setManualNote] = useState('');
    const [styleDescription, setStyleDescription] = useState('');
    const recognitionRef = useRef(null);

    const notes = Array.isArray(chapter.notes) ? chapter.notes : [];

    const startRecording = () => {
      if (!supportsSpeech) return;

      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!SpeechRecognition) return;

      const recognition = new SpeechRecognition();
      recognition.lang = 'es-ES';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        setIsRecording(true);
      };

      recognition.onerror = (event) => {
        const err = event && event.error ? event.error : 'desconocido';
        alert(
          'Error de reconocimiento de voz: ' +
            err +
            '.\n\nComprueba que el navegador permite usar el micr√≥fono.'
        );
        setIsRecording(false);
      };

      recognition.onresult = (event) => {
        let transcript = '';
        if (
          event &&
          event.results &&
          event.results[0] &&
          event.results[0][0]
        ) {
          transcript = event.results[0][0].transcript;
        }
        const cleaned = cleanTranscription(transcript);
        if (cleaned) {
          onAddNote(cleaned);
        }
      };

      recognition.onend = () => {
        setIsRecording(false);
      };

      recognitionRef.current = recognition;
      try {
        recognition.start();
      } catch (e) {
        alert(
          'No se pudo iniciar la grabaci√≥n. Aseg√∫rate de que el sitio est√° en HTTPS o en localhost.'
        );
      }
    };

    const stopRecording = () => {
      if (recognitionRef.current) {
        try {
          recognitionRef.current.stop();
        } catch (e) {}
      }
      setIsRecording(false);
    };

    const toggleRecording = () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    };

    const handleManualAdd = () => {
      const text = manualNote.trim();
      if (!text) return;
      const cleaned = cleanTranscription(text);
      onManualNoteAdd(cleaned);
      setManualNote('');
    };

    const toggleNoteSelection = (noteId) => {
      setSelectedNoteIds((prev) => {
        if (prev.indexOf(noteId) >= 0) {
          return prev.filter((id) => id !== noteId);
        } else {
          return prev.concat(noteId);
        }
      });
    };

    const allSelected =
      notes.length > 0 && selectedNoteIds.length === notes.length;

    const toggleSelectAll = () => {
      if (allSelected) {
        setSelectedNoteIds([]);
      } else {
        setSelectedNoteIds(notes.map((n) => n.id));
      }
    };

    const handleMergeSelected = () => {
      if (selectedNoteIds.length < 2) {
        alert('Selecciona al menos 2 notas para fusionar.');
        return;
      }
      onMergeNotes(selectedNoteIds);
    };

    const handleStyleChange = () => {
      if (!styleDescription.trim()) {
        alert('Describe el estilo deseado antes de aplicar el cambio.');
        return;
      }
      if (targetScope === 'selected' && selectedNoteIds.length === 0) {
        alert('Selecciona al menos una nota si el objetivo son notas seleccionadas.');
        return;
      }
      onStyleChange({
        scope: targetScope,
        selectedNoteIds: selectedNoteIds,
        styleDescription: styleDescription.trim(),
      });
    };

    const notesCount = notes.length;

    return (
      <div className="content-card">
        <div className="section-header">
          <div className="section-title-group">
            <div className="section-title">
              <span className="emoji">üìù</span>
              <span>{chapter.title}</span>
            </div>
            <div className="section-subtitle">
              {notesCount} nota{notesCount === 1 ? '' : 's'} en este cap√≠tulo.
            </div>
          </div>
          <div className="section-actions">
            <button
              className={
                'record-btn' + (isRecording || aiLoading ? ' disabled' : '')
              }
              onClick={toggleRecording}
              disabled={aiLoading}
            >
              <span
                className={
                  'record-indicator' + (isRecording ? ' pulsing' : '')
                }
              />
              <span>
                {isRecording ? 'Grabando‚Ä¶ pulsa para parar' : 'Grabar nota'}
              </span>
            </button>
          </div>
        </div>

        {!supportsSpeech && (
          <div className="chip">
            <span className="dot dot-red" />
            <span>
              Tu navegador no soporta la Web Speech API. Usa las notas de texto manual.
            </span>
          </div>
        )}

        <div className="notes-layout">
          <div className="notes-toolbar">
            <div className="notes-left-controls">
              <div className="segmented-control">
                <button
                  type="button"
                  className={
                    'segmented-option' +
                    (targetScope === 'selected' ? ' active' : '')
                  }
                  onClick={() => setTargetScope('selected')}
                >
                  <span className="dot-mini" />
                  <span>Notas seleccionadas</span>
                </button>
                <button
                  type="button"
                  className={
                    'segmented-option' +
                    (targetScope === 'chapter' ? ' active' : '')
                  }
                  onClick={() => setTargetScope('chapter')}
                >
                  <span className="dot-mini" />
                  <span>Cap√≠tulo completo</span>
                </button>
                <button
                  type="button"
                  className={
                    'segmented-option' +
                    (targetScope === 'book' ? ' active' : '')
                  }
                  onClick={() => setTargetScope('book')}
                >
                  <span className="dot-mini" />
                  <span>Libro completo</span>
                </button>
              </div>
            </div>

            <div className="notes-right-controls">
              <input
                className="style-input"
                placeholder='Describe el estilo: "m√°s narrativo y emocional", "m√°s t√©cnico y conciso", etc.'
                value={styleDescription}
                onChange={(e) => setStyleDescription(e.target.value)}
              />
              <button
                className={
                  'btn-outline btn-sm' + (aiLoading ? ' disabled' : '')
                }
                onClick={handleMergeSelected}
                disabled={aiLoading}
              >
                <span>üß©</span>
                <span>Fusionar notas (nueva nota)</span>
              </button>
              <button
                className={
                  'btn-primary btn-sm' + (aiLoading ? ' disabled' : '')
                }
                onClick={handleStyleChange}
                disabled={aiLoading}
              >
                <span>‚ú®</span>
                <span>Cambiar estilo</span>
              </button>
            </div>
          </div>

          <div className="notes-list">
            {notes.length === 0 ? (
              <div className="list-empty">
                Todav√≠a no hay notas en este cap√≠tulo.
                <div className="pill-helper">
                  <span className="pill-helper-dot" />
                  <span>
                    Pulsa "Grabar nota" para dictar o a√±ade una nota manual m√°s abajo.
                  </span>
                </div>
              </div>
            ) : (
              <>
                <div className="manual-note-actions" style={{ marginBottom: 4 }}>
                  <button
                    type="button"
                    className="btn-ghost btn-sm"
                    onClick={toggleSelectAll}
                  >
                    <span>‚òë</span>
                    <span>
                      {allSelected ? 'Quitar selecci√≥n' : 'Seleccionar todo'}
                    </span>
                  </button>
                  <span className="helper-inline">
                    {selectedNoteIds.length} seleccionada
                    {selectedNoteIds.length === 1 ? '' : 's'}.
                  </span>
                </div>

                {notes.map((note) => {
                  const selected = selectedNoteIds.indexOf(note.id) >= 0;
                  let timeLabel = '';
                  if (note && note.createdAt) {
                    const date = new Date(note.createdAt);
                    if (!isNaN(date.getTime())) {
                      timeLabel = date.toLocaleString();
                    }
                  }
                  return (
                    <label
                      key={note.id}
                      className={
                        'note-item' + (selected ? ' selected' : '')
                      }
                    >
                      <input
                        type="checkbox"
                        className="note-checkbox"
                        checked={selected}
                        onChange={() => toggleNoteSelection(note.id)}
                        onClick={(e) => e.stopPropagation()}
                      />
                      <div className="note-body">
                        <div className="note-text">{note.text}</div>
                        <div className="note-meta">
                          <span className="note-time">{timeLabel}</span>
                          <div className="note-actions">
                            <span className="note-chip">
                              {selected ? 'Seleccionada' : 'Toca para seleccionar'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </label>
                  );
                })}
              </>
            )}
          </div>

          <div className="manual-note-box">
            <div>
              A√±adir nota de texto manual (sin voz):
            </div>
            <textarea
              className="manual-note-textarea"
              placeholder="Escribe aqu√≠ una nota. Solo se limpiar√° lo m√≠nimo (may√∫scula inicial, punto final, espacios)."
              value={manualNote}
              onChange={(e) => setManualNote(e.target.value)}
            />
            <div className="manual-note-actions">
              <span className="helper-inline">
                Se aplicar√° la misma limpieza m√≠nima que a las notas dictadas.
              </span>
              <button
                className="btn-outline btn-sm"
                onClick={handleManualAdd}
              >
                <span>‚ûï</span>
                <span>Guardar nota</span>
              </button>
            </div>
          </div>

          <div className="status-bar">
            {aiLoading && (
              <div className="status-pill loading">
                <span className="spinner" />
                <span>Hablando con Gemini‚Ä¶</span>
              </div>
            )}
            {aiError && !aiLoading && (
              <div className="status-pill error">
                <span className="dot" />
                <span>{aiError}</span>
              </div>
            )}
            {infoMessage && !aiError && !aiLoading && (
              <div className="status-pill success">
                <span className="dot" />
                <span>{infoMessage}</span>
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  function SettingsPanel({ settings, onChangeSettings }) {
    const [localSettings, setLocalSettings] = useState(settings);

    useEffect(() => {
      setLocalSettings(settings);
    }, [settings]);

    const handleChange = (field, value) => {
      const updated = Object.assign({}, localSettings, { [field]: value });
      setLocalSettings(updated);
      onChangeSettings(updated);
    };

    return (
      <div className="content-card">
        <div className="section-header">
          <div className="section-title-group">
            <div className="section-title">
              <span className="emoji">‚öôÔ∏è</span>
              <span>Opciones &bull; Gemini</span>
            </div>
            <div className="section-subtitle">
              API key y prompts base usados en las funciones con IA.
            </div>
          </div>
        </div>

        <div className="settings-panel">
          <div className="settings-section">
            <div className="settings-title">
              <span className="icon">üîë</span>
              <span>API key de Gemini</span>
            </div>
            <div className="settings-description">
              Introduce aqu√≠ tu API key de Gemini. Se guardar√° en tu navegador
              (localStorage) y la app la usar√° para las llamadas a la IA.
            </div>
            <div className="field-label">
              <span>API key (no se mostrar√° a nadie m√°s)</span>
              <span className="badge">Obligatorio para IA</span>
            </div>
            <input
              className="settings-input"
              type="password"
              value={localSettings.apiKey}
              placeholder="Pega aqu√≠ tu API key de Gemini‚Ä¶"
              onChange={(e) => handleChange('apiKey', e.target.value)}
            />
            <div className="settings-footer">
              <span>
                Se guarda solo en este navegador (localStorage).
              </span>
              <span>Puedes cambiarla cuando quieras.</span>
            </div>
          </div>

          <div className="settings-section">
            <div className="settings-title">
              <span className="icon">üß©</span>
              <span>Prompt base para FUSI√ìN de notas</span>
            </div>
            <div className="settings-description">
              Este prompt se env√≠a a Gemini cuando usas ‚ÄúFusionar notas‚Äù. Puedes
              ajustarlo si quieres que la fusi√≥n sea m√°s o menos literal.
            </div>
            <div className="field-label">
              <span>Prompt base</span>
              <span className="badge">Se concatena con las notas seleccionadas</span>
            </div>
            <textarea
              className="settings-textarea"
              value={localSettings.mergePrompt}
              onChange={(e) => handleChange('mergePrompt', e.target.value)}
            />
          </div>

          <div className="settings-section">
            <div className="settings-title">
              <span className="icon">‚ú®</span>
              <span>Prompt base para CAMBIO de estilo</span>
            </div>
            <div className="settings-description">
              Este prompt se usa junto con tu descripci√≥n de estilo al pulsar
              ‚ÄúCambiar estilo‚Äù. El contenido puede ser desde unas pocas notas
              hasta un cap√≠tulo o casi un libro entero.
            </div>
            <div className="field-label">
              <span>Prompt base</span>
              <span className="badge">Se concatena con estilo + contenido</span>
            </div>
            <textarea
              className="settings-textarea"
              value={localSettings.stylePrompt}
              onChange={(e) => handleChange('stylePrompt', e.target.value)}
            />
            <div className="settings-footer">
              <span>
                Mant√©n claro que no debe inventar ni borrar ideas.
              </span>
              <span>Los cambios se guardan al vuelo.</span>
            </div>
          </div>
        </div>
      </div>
    );
  }

  function App() {
    const [books, setBooks] = useState([]);
    const [currentBookId, setCurrentBookId] = useState(null);
    const [currentChapterId, setCurrentChapterId] = useState(null);
    const [settings, setSettings] = useState(defaultSettings);
    const [showSettings, setShowSettings] = useState(false);

    const [selectedNoteIds, setSelectedNoteIds] = useState([]);
    const [targetScope, setTargetScope] = useState('selected');

    const [aiLoading, setAiLoading] = useState(false);
    const [aiError, setAiError] = useState('');
    const [infoMessage, setInfoMessage] = useState('');

    const [supportsSpeech, setSupportsSpeech] = useState(true);

    useEffect(() => {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.DATA);
        if (stored) {
          const parsed = JSON.parse(stored);
          if (Array.isArray(parsed)) {
            setBooks(parsed);
          }
        }
      } catch (e) {
        console.error('Error cargando datos:', e);
      }

      try {
        const storedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
        if (storedSettings) {
          const parsedSettings = JSON.parse(storedSettings);
          const merged = Object.assign({}, defaultSettings, parsedSettings || {});
          setSettings(merged);
        }
      } catch (e) {
        console.error('Error cargando settings:', e);
      }

      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        setSupportsSpeech(false);
      }
    }, []);

    useEffect(() => {
      try {
        localStorage.setItem(STORAGE_KEYS.DATA, JSON.stringify(books));
      } catch (e) {
        console.error('Error guardando datos:', e);
      }
    }, [books]);

    useEffect(() => {
      try {
        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
      } catch (e) {
        console.error('Error guardando settings:', e);
      }
    }, [settings]);

    useEffect(() => {
      setAiError('');
      setInfoMessage('');
    }, [currentBookId, currentChapterId, showSettings]);

    let currentBook = null;
    for (let i = 0; i < books.length; i++) {
      if (books[i].id === currentBookId) {
        currentBook = books[i];
        break;
      }
    }

    let currentChapter = null;
    if (currentBook && Array.isArray(currentBook.chapters)) {
      for (let i = 0; i < currentBook.chapters.length; i++) {
        if (currentBook.chapters[i].id === currentChapterId) {
          currentChapter = currentBook.chapters[i];
          break;
        }
      }
    }

    const isAtBooks = !currentBookId;
    const isAtChapters = !!currentBookId && !currentChapterId;
    const isAtNotes = !!currentBookId && !!currentChapterId;

    const handleCreateBook = (title) => {
      const newBook = {
        id: genId('book'),
        title: title,
        chapters: [],
      };
      setBooks((prev) => prev.concat(newBook));
    };

    const handleOpenBook = (bookId) => {
      setCurrentBookId(bookId);
      setCurrentChapterId(null);
      setSelectedNoteIds([]);
      setShowSettings(false);
    };

    const handleCreateChapter = (title) => {
      if (!currentBook) return;
      const newChapter = {
        id: genId('chapter'),
        title: title,
        notes: [],
      };
      setBooks((prev) =>
        prev.map((book) => {
          if (book.id !== currentBook.id) return book;
          const chapters = Array.isArray(book.chapters) ? book.chapters.slice() : [];
          chapters.push(newChapter);
          return Object.assign({}, book, { chapters: chapters });
        })
      );
    };

    const handleOpenChapter = (chapterId) => {
      setCurrentChapterId(chapterId);
      setSelectedNoteIds([]);
      setShowSettings(false);
    };

    const handleAddNoteToCurrentChapter = (text) => {
      if (!currentBook || !currentChapter) return;
      const newNote = {
        id: genId('note'),
        text: text,
        createdAt: new Date().toISOString(),
      };

      setBooks((prev) =>
        prev.map((book) => {
          if (book.id !== currentBook.id) return book;
          const chapters = (book.chapters || []).map((ch) => {
            if (ch.id !== currentChapter.id) return ch;
            const notes = Array.isArray(ch.notes) ? ch.notes.slice() : [];
            notes.push(newNote);
            return Object.assign({}, ch, { notes: notes });
          });
          return Object.assign({}, book, { chapters: chapters });
        })
      );
    };

    const handleMergeNotes = async (noteIds) => {
      if (!currentBook || !currentChapter) return;
      if (!noteIds || noteIds.length < 2) {
        setAiError('Selecciona al menos 2 notas para fusionar.');
        return;
      }

      let bookForMerge = null;
      for (let i = 0; i < books.length; i++) {
        if (books[i].id === currentBook.id) {
          bookForMerge = books[i];
          break;
        }
      }
      if (!bookForMerge || !Array.isArray(bookForMerge.chapters)) return;

      let chapter = null;
      for (let i = 0; i < bookForMerge.chapters.length; i++) {
        if (bookForMerge.chapters[i].id === currentChapter.id) {
          chapter = bookForMerge.chapters[i];
          break;
        }
      }
      if (!chapter || !Array.isArray(chapter.notes)) return;

      const selectedNotes = chapter.notes.filter((n) => noteIds.indexOf(n.id) >= 0);
      if (selectedNotes.length < 2) {
        setAiError('No se encontraron suficientes notas seleccionadas en el cap√≠tulo.');
        return;
      }

      const mergePrompt = settings.mergePrompt || defaultSettings.mergePrompt;

      const userPrompt =
        'Fusiona coherentemente las siguientes notas en un solo texto:\n\n' +
        selectedNotes
          .map((n, idx) => String(idx + 1) + '. ' + n.text)
          .join('\n\n');

      setAiLoading(true);
      setAiError('');
      setInfoMessage('');

      try {
        const fusedText = await callGemini({
          apiKey: settings.apiKey,
          systemPrompt: mergePrompt,
          userPrompt: userPrompt,
        });

        const newNote = {
          id: genId('note'),
          text: fusedText,
          createdAt: new Date().toISOString(),
        };

        setBooks((prev) =>
          prev.map((book) => {
            if (book.id !== currentBook.id) return book;
            const chapters = (book.chapters || []).map((ch) => {
              if (ch.id !== currentChapter.id) return ch;
              const notes = Array.isArray(ch.notes) ? ch.notes.slice() : [];
              notes.push(newNote);
              return Object.assign({}, ch, { notes: notes });
            });
            return Object.assign({}, book, { chapters: chapters });
          })
        );

        setInfoMessage(
          'Fusi√≥n completada: se ha creado una nueva nota a partir de las seleccionadas (las originales se mantienen).'
        );
      } catch (e) {
        console.error(e);
        setAiError(e.message || 'Error al fusionar notas con Gemini.');
      } finally {
        setAiLoading(false);
      }
    };

    const handleStyleChange = async ({ scope, selectedNoteIds, styleDescription }) => {
      if (!currentBook) return;

      const stylePrompt = settings.stylePrompt || defaultSettings.stylePrompt;

      let contentText = '';
      let contextLabel = '';
      let affectedChaptersIds = [];
      let noteIdsToReplaceInChapter = [];

      if (scope === 'selected') {
        if (!currentChapter || !selectedNoteIds || selectedNoteIds.length === 0) {
          setAiError(
            'Debes seleccionar al menos una nota si el alcance es "Notas seleccionadas".'
          );
          return;
        }

        let bookCopy = null;
        for (let i = 0; i < books.length; i++) {
          if (books[i].id === currentBook.id) {
            bookCopy = books[i];
            break;
          }
        }
        if (!bookCopy || !Array.isArray(bookCopy.chapters)) return;

        let chapter = null;
        for (let i = 0; i < bookCopy.chapters.length; i++) {
          if (bookCopy.chapters[i].id === currentChapter.id) {
            chapter = bookCopy.chapters[i];
            break;
          }
        }
        if (!chapter || !Array.isArray(chapter.notes)) {
          setAiError('No se encontraron notas en el cap√≠tulo.');
          return;
        }

        const selectedNotes = chapter.notes.filter(
          (n) => selectedNoteIds.indexOf(n.id) >= 0
        );
        if (selectedNotes.length === 0) {
          setAiError('No se encontraron notas seleccionadas en el cap√≠tulo.');
          return;
        }

        contentText = selectedNotes
          .map((n, idx) => String(idx + 1) + '. ' + n.text)
          .join('\n\n');
        contextLabel = 'notas seleccionadas del cap√≠tulo "' + chapter.title + '"';
        affectedChaptersIds = [chapter.id];
        noteIdsToReplaceInChapter = selectedNoteIds.slice();
      } else if (scope === 'chapter') {
        if (!currentChapter) return;

        let bookCopy = null;
        for (let i = 0; i < books.length; i++) {
          if (books[i].id === currentBook.id) {
            bookCopy = books[i];
            break;
          }
        }
        if (!bookCopy || !Array.isArray(bookCopy.chapters)) return;

        let chapter = null;
        for (let i = 0; i < bookCopy.chapters.length; i++) {
          if (bookCopy.chapters[i].id === currentChapter.id) {
            chapter = bookCopy.chapters[i];
            break;
          }
        }
        if (!chapter || !Array.isArray(chapter.notes) || chapter.notes.length === 0) {
          setAiError('El cap√≠tulo actual no tiene notas para reescribir.');
          return;
        }

        contentText = chapter.notes
          .map((n, idx) => String(idx + 1) + '. ' + n.text)
          .join('\n\n');
        contextLabel = 'todas las notas del cap√≠tulo "' + chapter.title + '"';
        affectedChaptersIds = [chapter.id];
        noteIdsToReplaceInChapter = chapter.notes.map((n) => n.id);
      } else if (scope === 'book') {
        if (!Array.isArray(currentBook.chapters) || currentBook.chapters.length === 0) {
          setAiError('Este libro no tiene cap√≠tulos ni notas para reescribir.');
          return;
        }

        const allNotes = [];
        for (let ci = 0; ci < currentBook.chapters.length; ci++) {
          const ch = currentBook.chapters[ci];
          const chNotes = Array.isArray(ch.notes) ? ch.notes : [];
          for (let ni = 0; ni < chNotes.length; ni++) {
            const n = chNotes[ni];
            allNotes.push(
              'Cap√≠tulo ' +
                String(ci + 1) +
                ' - ' +
                ch.title +
                ', nota ' +
                String(ni + 1) +
                ':\n' +
                n.text
            );
          }
        }
        if (allNotes.length === 0) {
          setAiError('Este libro no tiene notas para reescribir.');
          return;
        }

        contentText = allNotes.join('\n\n---\n\n');
        contextLabel =
          'todas las notas del libro completo "' + currentBook.title + '"';
        affectedChaptersIds = currentBook.chapters.map((c) => c.id);
      } else {
        setAiError('√Åmbito de cambio de estilo no reconocido.');
        return;
      }

      const userPrompt =
        'Aplica el siguiente estilo a ' +
        contextLabel +
        ':\n\n' +
        'Estilo solicitado por el usuario: "' +
        styleDescription +
        '"\n\n' +
        'Contenido original:\n\n' +
        contentText;

      setAiLoading(true);
      setAiError('');
      setInfoMessage('');

      try {
        const styledText = await callGemini({
          apiKey: settings.apiKey,
          systemPrompt: stylePrompt,
          userPrompt: userPrompt,
        });

        if (scope === 'book') {
          const newChapter = {
            id: genId('chapter'),
            title: 'Libro reescrito (estilo aplicado)',
            notes: [
              {
                id: genId('note'),
                text: styledText,
                createdAt: new Date().toISOString(),
              },
            ],
          };

          setBooks((prev) =>
            prev.map((book) => {
              if (book.id !== currentBook.id) return book;
              const chapters = Array.isArray(book.chapters)
                ? book.chapters.slice()
                : [];
              chapters.push(newChapter);
              return Object.assign({}, book, { chapters: chapters });
            })
          );

          setInfoMessage(
            'Cambio de estilo completo aplicado al libro. Se ha creado un cap√≠tulo nuevo con la versi√≥n reescrita; los cap√≠tulos originales se mantienen.'
          );
        } else {
          const newSingleNote = {
            id: genId('note'),
            text: styledText,
            createdAt: new Date().toISOString(),
          };

          setBooks((prev) =>
            prev.map((book) => {
              if (book.id !== currentBook.id) return book;
              const chapters = (book.chapters || []).map((ch) => {
                if (affectedChaptersIds.indexOf(ch.id) < 0) return ch;
                const originalNotes = Array.isArray(ch.notes)
                  ? ch.notes
                  : [];
                const filteredNotes = originalNotes.filter(
                  (n) => noteIdsToReplaceInChapter.indexOf(n.id) < 0
                );
                const notes = filteredNotes.concat(newSingleNote);
                return Object.assign({}, ch, { notes: notes });
              });
              return Object.assign({}, book, { chapters: chapters });
            })
          );

          if (scope === 'selected') {
            setInfoMessage(
              'Estilo aplicado: las notas seleccionadas se han fusionado y sustituido por una nota nueva reescrita.'
            );
          } else {
            setInfoMessage(
              'Estilo aplicado al cap√≠tulo completo: todas las notas se han sustituido por una nota nueva reescrita.'
            );
          }
        }

        setSelectedNoteIds([]);
      } catch (e) {
        console.error(e);
        setAiError(e.message || 'Error al cambiar el estilo con Gemini.');
      } finally {
        setAiLoading(false);
      }
    };

    const handleSettingsToggle = () => {
      setShowSettings((prev) => !prev);
    };

    const handleBack = () => {
      if (isAtNotes) {
        setCurrentChapterId(null);
        setSelectedNoteIds([]);
      } else if (isAtChapters) {
        setCurrentBookId(null);
        setCurrentChapterId(null);
        setSelectedNoteIds([]);
      }
    };

    const canGoBack = !isAtBooks;
    const apiKeyConfigured = !!settings.apiKey;

    return (
      <div className="app-shell">
        <div className="blobs">
          <div className="blob blob-1" />
          <div className="blob blob-2" />
          <div className="blob blob-3" />
          <div className="blob blob-4" />
        </div>
        <div className="app-inner">
          <header className="app-header">
            <div className="header-left">
              {canGoBack && (
                <button className="back-btn" onClick={handleBack}>
                  <span>‚Äπ</span>
                </button>
              )}
              <div className="app-title-wrapper">
                <h1 className="app-title">
                  <span className="title-accent">Libros</span>
                  <span>&gt;</span>
                  <span className="title-accent">IA</span>
                  <span className="title-pill">voz‚Üítexto</span>
                </h1>
                <p className="app-subtitle">
                  <span>
                    <span className="subtitle-dot" />
                    <span>Libro ‚Üí cap√≠tulos ‚Üí notas ¬∑ Gemini para fusionar y reescribir.</span>
                  </span>
                </p>
              </div>
            </div>
            <div className="header-right">
              <div className="pill-indicator">
                IA:&nbsp;
                <strong>{apiKeyConfigured ? 'configurada' : 'sin API key'}</strong>
              </div>
              <button
                className={
                  'settings-btn' + (showSettings ? ' active' : '')
                }
                onClick={handleSettingsToggle}
              >
                <span className="icon">‚öôÔ∏è</span>
                <span className="label">
                  {showSettings ? 'Cerrar' : 'Opciones'}
                </span>
              </button>
            </div>
          </header>

          <main className="app-main">
            {showSettings ? (
              <SettingsPanel
                settings={settings}
                onChangeSettings={setSettings}
              />
            ) : isAtBooks ? (
              <BookList
                books={books}
                onCreateBook={handleCreateBook}
                onOpenBook={handleOpenBook}
              />
            ) : isAtChapters && currentBook ? (
              <ChapterList
                book={currentBook}
                onCreateChapter={handleCreateChapter}
                onOpenChapter={handleOpenChapter}
              />
            ) : isAtNotes && currentBook && currentChapter ? (
              <ChapterView
                book={currentBook}
                chapter={currentChapter}
                selectedNoteIds={selectedNoteIds}
                setSelectedNoteIds={setSelectedNoteIds}
                targetScope={targetScope}
                setTargetScope={setTargetScope}
                onAddNote={handleAddNoteToCurrentChapter}
                onManualNoteAdd={handleAddNoteToCurrentChapter}
                onMergeNotes={handleMergeNotes}
                onStyleChange={handleStyleChange}
                aiLoading={aiLoading}
                aiError={aiError}
                infoMessage={infoMessage}
                supportsSpeech={supportsSpeech}
              />
            ) : (
              <BookList
                books={books}
                onCreateBook={handleCreateBook}
                onOpenBook={handleOpenBook}
              />
            )}
          </main>

          <footer className="app-footer">
            <div className="footer-pill">
              <span className="dot" />
              <span>
                Datos y configuraci√≥n se guardan en localStorage.
              </span>
            </div>
            <div className="footer-right">
              <span className="tag">Web Speech API*</span>
              <span className="tag">Gemini LLM</span>
            </div>
          </footer>
        </div>
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
</script>
</body>
</html>
